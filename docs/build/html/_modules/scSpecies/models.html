

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scspecies.models &mdash; scspecies Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css?v=572af1d6" />
      <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            scspecies
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Navigation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips to fit scSpecies</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">scspecies</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scspecies.models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scspecies.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">muon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mu</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.distributions.normal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ad</span>


<div class="viewcode-block" id="create_structure">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.create_structure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_structure</span><span class="p">(</span>
        <span class="n">structure</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">layer_order</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds neural network architectures based on a list of layer sizes and operation order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    structure : list of int</span>
<span class="sd">        No. of neurons in each layer, including input and output dimensions.  </span>
<span class="sd">        For example, [input_dim, hidden1_dim, ..., output_dim]. Must have at least two entries.</span>
<span class="sd">    layer_order : list</span>
<span class="sd">        Sequence of layer specifications. Each element must be either</span>

<span class="sd">        1: &#39;linear&#39;, </span>
<span class="sd">            Affine linear transformation</span>

<span class="sd">        2: &#39;batch_norm&#39;, </span>
<span class="sd">            Batch normalization</span>

<span class="sd">        3: &#39;layer_norm&#39;, </span>
<span class="sd">            Layer normalization</span>

<span class="sd">        4: (&#39;act&#39;, activation: nn.Module or &#39;PReLU&#39;, [min_clip, max_clip] optional),</span>
<span class="sd">            Activation function. Unbounded activation functions should be clipped for numerical stability, example: (&#39;act&#39;, torch.nn.ReLU(), [0, 6])</span>

<span class="sd">        5: (&#39;dropout&#39;, dropout rate - float in [0, 1]), </span>
<span class="sd">            Dropout layer, example: (&#39;dropout&#39;, 0.1)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nn.Sequential</span>
<span class="sd">        A sequential container of PyTorch layers in the specified order for each pair in `structure`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer_operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layer_order</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;dropout&#39;</span> <span class="ow">in</span> <span class="n">layer_operations</span><span class="p">:</span> 
        <span class="n">dr_ind</span> <span class="o">=</span> <span class="n">layer_operations</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">)</span>
        <span class="n">dropout</span> <span class="o">=</span> <span class="n">layer_order</span><span class="p">[</span><span class="n">dr_ind</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">act_ind</span> <span class="o">=</span> <span class="n">layer_operations</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;act&#39;</span><span class="p">)</span>
    <span class="n">act</span> <span class="o">=</span> <span class="n">layer_order</span><span class="p">[</span><span class="n">act_ind</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_order</span><span class="p">[</span><span class="n">act_ind</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">clip_act</span> <span class="o">=</span> <span class="n">layer_order</span><span class="p">[</span><span class="n">act_ind</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span> 
        <span class="n">clip_act</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">neurons_in</span><span class="p">,</span> <span class="n">neurons_out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">structure</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">layer_operations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">neurons_in</span><span class="p">,</span> <span class="n">neurons_out</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;act&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">act</span> <span class="o">==</span> <span class="s1">&#39;PReLU&#39;</span><span class="p">:</span> <span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">PReLU</span><span class="p">(</span><span class="n">num_parameters</span><span class="o">=</span><span class="n">neurons_out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">act</span> <span class="o">=</span> <span class="n">act</span>

                <span class="k">if</span> <span class="n">clip_act</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_act_bounded</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">clip_act</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">clip_act</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>                      
            <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;dropout&#39;</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;layer_norm&#39;</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">neurons_out</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;batch_norm&#39;</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">neurons_out</span><span class="p">))</span>                    
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_act_bounded">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.make_act_bounded">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">make_act_bounded</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper module that applies an activation and clips its output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    act : nn.Module</span>
<span class="sd">        Activation function to apply.</span>
<span class="sd">    min : float</span>
<span class="sd">        Lower bound for clipping.</span>
<span class="sd">    max : float</span>
<span class="sd">        Upper bound for clipping.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="make_act_bounded.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.make_act_bounded.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">act</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
            <span class="nb">min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">:</span> <span class="nb">float</span>
        <span class="p">):</span>
      
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">act</span>         
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="nb">min</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="nb">max</span>    </div>


<div class="viewcode-block" id="make_act_bounded.forward">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.make_act_bounded.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Encoder_outer">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_outer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Encoder_outer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Outer encoder module that concatenates data and labels, then applies a feed-forward network.</span>
<span class="sd">    Will be reinitialized by scSpecies after pre-training on a context dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_dict : dict</span>
<span class="sd">        Dictionary with keys:</span>
<span class="sd">        - &#39;data_dim&#39; (int): Dimensionality of input data.</span>
<span class="sd">        - &#39;label_dim&#39; (int): Dimensionality of input labels.</span>
<span class="sd">        - &#39;dims_enc_outer&#39; (list of int): Hidden layer sizes after concatenation.</span>
<span class="sd">        - &#39;layer_order&#39; (list): See `create_structure` for format.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : nn.Sequential</span>
<span class="sd">        The feed-forward network created by `create_structure`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Encoder_outer.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_outer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">param_dict</span><span class="p">:</span> <span class="nb">dict</span>
        <span class="p">):</span>
   
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder_outer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">layer_order</span><span class="o">=</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;layer_order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;data_dim&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;label_dim&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;dims_enc_outer&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">create_structure</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> 
                                      <span class="n">layer_order</span><span class="o">=</span><span class="n">layer_order</span><span class="p">,</span>
                                      <span class="p">)</span></div>


<div class="viewcode-block" id="Encoder_outer.forward">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_outer.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">label_inp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass through the outer encoder layers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : torch.Tensor</span>
<span class="sd">            Input data tensor of shape (batch_size, data_dim).</span>
<span class="sd">        label_inp : torch.Tensor</span>
<span class="sd">            Input label tensor of shape (batch_size, label_dim).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Encoded representation of shape (batch_size, dims_enc_outer[-1]).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> </div>
</div>


    
<div class="viewcode-block" id="Encoder_inner">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_inner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Encoder_inner</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inner encoder module producing Gaussian latent parameters and sampling latent variables.</span>
<span class="sd">    Will be shared between context and target scVI self.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    device : str</span>
<span class="sd">        Device identifier for sampling (&#39;cpu&#39;, &#39;mps&#39; or &#39;cuda&#39;).</span>
<span class="sd">    param_dict : dict</span>
<span class="sd">        Dictionary with keys:</span>
<span class="sd">        - &#39;dims_enc_outer&#39; (list of int): Output dims of outer encoder.</span>
<span class="sd">        - &#39;dims_enc_inner&#39; (list of int): Hidden layer sizes for inner encoder.</span>
<span class="sd">        - &#39;lat_dim&#39; (int): Dimensionality of the latent space.</span>
<span class="sd">        - &#39;layer_order&#39; (list): See `create_structure`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : nn.Sequential</span>
<span class="sd">        Feed-forward network for intermediate representation.</span>
<span class="sd">    mu : nn.Linear</span>
<span class="sd">        Linear layer mapping to latent mean.</span>
<span class="sd">    log_sig : nn.Linear</span>
<span class="sd">        Linear layer mapping to log-standard deviation.</span>
<span class="sd">    sampling_dist : Normal</span>
<span class="sd">        Standard normal distribution for sampling latent representations.</span>

<span class="sd">    &quot;&quot;&quot;</span>


<div class="viewcode-block" id="Encoder_inner.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_inner.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">param_dict</span><span class="p">:</span> <span class="nb">dict</span>
        <span class="p">):</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder_inner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;dims_enc_outer&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;dims_enc_inner&#39;</span><span class="p">]</span>

        <span class="n">layer_order</span><span class="o">=</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;layer_order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">create_structure</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> 
                                      <span class="n">layer_order</span><span class="o">=</span><span class="n">layer_order</span><span class="p">,</span>
                                      <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;lat_dim&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;lat_dim&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_dist</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;lat_dim&#39;</span><span class="p">]]),</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)),</span> 
            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;lat_dim&#39;</span><span class="p">]]),</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Encoder_inner.encode">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_inner.encode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">inter</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute latent mean and log-std from intermediate representation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inter : torch.Tensor</span>
<span class="sd">            Intermediate features of shape (batch_size, dims_enc_inner[-1]).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mu : torch.Tensor</span>
<span class="sd">            Latent means of shape (batch_size, lat_dim).</span>
<span class="sd">        log_sig : torch.Tensor</span>
<span class="sd">            Latent log-standard deviations of shape (batch_size, lat_dim).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">log_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_sig</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_sig</span></div>



<div class="viewcode-block" id="Encoder_inner.forward">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Encoder_inner.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">inter</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample latent variable and compute KL-Divergence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inter : torch.Tensor</span>
<span class="sd">            Intermediate features from outer encoder.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        z : torch.Tensor</span>
<span class="sd">            Sampled latent tensor of shape (batch_size, lat_dim).</span>
<span class="sd">        kl_div : torch.Tensor</span>
<span class="sd">            Scalar KL-Divergence across the batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mu</span><span class="p">,</span> <span class="n">log_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">log_sig</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)]))</span> 
        <span class="n">kl_div</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">log_sig</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">log_sig</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">log_sig</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">*</span> <span class="n">eps</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">kl_div</span></div>
</div>


<div class="viewcode-block" id="Library_encoder">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Library_encoder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Library_encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encoder for library size factor, modeling a 1D log-normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    device : str</span>
<span class="sd">        Device identifier for sampling.</span>
<span class="sd">    param_dict : dict</span>
<span class="sd">        Dictionary with keys:</span>
<span class="sd">        - &#39;data_dim&#39;, &#39;label_dim&#39; (int): Input dims.</span>
<span class="sd">        - &#39;dims_l_enc&#39; (list of int): Hidden layer sizes.</span>
<span class="sd">        - &#39;lib_mu_add&#39; (float): Offset added to the mean.</span>
<span class="sd">        - &#39;layer_order&#39; (list): For `create_structure`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : nn.Sequential</span>
<span class="sd">        Feed-forward network for concatenated input.</span>
<span class="sd">    mu : nn.Linear</span>
<span class="sd">        Layer mapping to log-mean of library.</span>
<span class="sd">    log_sig : nn.Linear</span>
<span class="sd">        Layer mapping to log-std of library.</span>
<span class="sd">    sampling_dist : Normal</span>
<span class="sd">        Standard normal for sampling.</span>
<span class="sd">    mu_add : float</span>
<span class="sd">        Added to the decoded mean.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Library_encoder.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Library_encoder.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">device</span><span class="p">,</span>
            <span class="n">param_dict</span><span class="p">,</span>
            <span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Library_encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;data_dim&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;label_dim&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;dims_l_enc&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">create_structure</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> 
                                      <span class="n">layer_order</span><span class="o">=</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;layer_order&#39;</span><span class="p">],</span>
                                      <span class="p">)</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">mu_add</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;lib_mu_add&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_dist</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)),</span> 
            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span> </div>


<div class="viewcode-block" id="Library_encoder.encode">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Library_encoder.encode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">label_inp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute library log-mean and log-std from inputs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : torch.Tensor</span>
<span class="sd">            Data tensor of shape (batch_size, data_dim).</span>
<span class="sd">        label_inp : torch.Tensor</span>
<span class="sd">            Label tensor of shape (batch_size, label_dim).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mu : torch.Tensor</span>
<span class="sd">            Adjusted log-mean of shape (batch_size, 1).</span>
<span class="sd">        log_sig : torch.Tensor</span>
<span class="sd">            Log-std of shape (batch_size, 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">log_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_sig</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_add</span><span class="p">,</span> <span class="n">log_sig</span> </div>


<div class="viewcode-block" id="Library_encoder.forward">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Library_encoder.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">label_inp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">prior_mu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">prior_sig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample library factor and compute optional KL-Divergence to prior.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : torch.Tensor</span>
<span class="sd">            Input data.</span>
<span class="sd">        label_inp : torch.Tensor</span>
<span class="sd">            Input labels.</span>
<span class="sd">        prior_mu : torch.Tensor, optional</span>
<span class="sd">            Precomputed prior mean parameter for KL-Divergence.</span>
<span class="sd">        prior_sig : torch.Tensor, optional</span>
<span class="sd">            Precomputed prior std parameter for KL-Divergence.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        l : torch.Tensor</span>
<span class="sd">            Sampled library factor of shape (batch_size, 1).</span>
<span class="sd">        kl_div : torch.Tensor, optional</span>
<span class="sd">            KL-Divergence if prior_mu and prior_sig are not None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mu</span><span class="p">,</span> <span class="n">log_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">log_sig</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)]))</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">log_sig</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">*</span> <span class="n">eps</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">prior_mu</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">prior_sig</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kl_div</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prior_sig</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">-</span> <span class="n">log_sig</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">prior_sig</span><span class="o">.</span><span class="n">square</span><span class="p">()),</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">mu</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">prior_mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">log_sig</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span> <span class="o">-</span> <span class="n">prior_sig</span><span class="o">.</span><span class="n">square</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">kl_div</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">l</span></div>
</div>


<div class="viewcode-block" id="Decoder">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Decoder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decoder mapping latent and label inputs back to data distribution parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_dict : dict</span>
<span class="sd">        Dictionary with keys:</span>
<span class="sd">        - &#39;lat_dim&#39;, &#39;label_dim&#39;, &#39;data_dim&#39; (int): Latent, label, and data dims.</span>
<span class="sd">        - &#39;dims_dec&#39; (list of int): Hidden layer sizes.</span>
<span class="sd">        - &#39;layer_order&#39; (list): For `create_structure`.</span>
<span class="sd">        - &#39;data_distr&#39; (str): &#39;nb&#39; or &#39;zinb&#39;.</span>
<span class="sd">        - &#39;dispersion&#39; (str): One of &#39;dataset&#39;, &#39;batch&#39;, &#39;cell&#39;.</span>
<span class="sd">        - &#39;dispersion&#39; and &#39;data_distr&#39; control parameter layers.</span>
<span class="sd">        - &#39;homologous_genes&#39; (list of int): Indices for homologous genes.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : nn.Sequential</span>
<span class="sd">        Feed-forward network for decoder.</span>
<span class="sd">    rho_pre : nn.Linear</span>
<span class="sd">        Linear layer for relative expression logits.</span>
<span class="sd">    log_alpha : Parameter or nn.Linear</span>
<span class="sd">        Dispersion parameter(s) depending on `dispersion`.</span>
<span class="sd">    pi_nlogit : nn.Linear, optional</span>
<span class="sd">        Zero-inflation logits if `data_distr == &#39;zinb&#39;`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Decoder.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Decoder.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">param_dict</span><span class="p">:</span> <span class="nb">dict</span>
        <span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;lat_dim&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;label_dim&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;dims_dec&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;data_distr&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;dispersion&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;homologous_genes&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_hom_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;data_dim&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_hom_genes</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;data_dim&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;zinb&#39;</span><span class="p">,</span> <span class="s1">&#39;nb&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_distr must be a list containing these strings: </span><span class="si">{</span><span class="s1">&#39;zinb&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nb&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dispersion must be a list containing these strings: </span><span class="si">{</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cell&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>     

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">create_structure</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> 
                                      <span class="n">layer_order</span><span class="o">=</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;layer_order&#39;</span><span class="p">],</span>
                                      <span class="p">)</span>   
          
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_pre</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;dataset&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;label_dim&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span><span class="p">))</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">==</span> <span class="s1">&#39;zinb&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pi_nlogit</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span><span class="p">)</span>    </div>


<div class="viewcode-block" id="Decoder.calc_nlog_likelihood">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Decoder.calc_nlog_likelihood">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_nlog_likelihood</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">dec_outp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
            <span class="n">library</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span> 

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute negative log-likelihood under NB or ZINB self.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dec_outp : list of torch.Tensor</span>
<span class="sd">            [alpha, rho] or [alpha, rho, pi_nlogit] depending on distribution.</span>
<span class="sd">        library : torch.Tensor</span>
<span class="sd">            Library size factor.</span>
<span class="sd">        x : torch.Tensor</span>
<span class="sd">            Observed count data.</span>
<span class="sd">        eps : float</span>
<span class="sd">            Numerical stability constant.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Negative log-likelihood per sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">==</span> <span class="s1">&#39;nb&#39;</span><span class="p">:</span>
            <span class="n">alpha</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">dec_outp</span> 
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">library</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">mu</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span>            
            <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>   

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">==</span> <span class="s1">&#39;zinb&#39;</span><span class="p">:</span>
            <span class="n">alpha</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">pi_nlogit</span> <span class="o">=</span> <span class="n">dec_outp</span>  
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span>            
            <span class="n">mu</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">library</span>
            <span class="n">log_alpha_mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">mu</span><span class="p">)</span>

            <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">,</span>
                <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pi_nlogit</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_alpha_mu</span><span class="p">))</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pi_nlogit</span><span class="p">),</span>
                <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pi_nlogit</span><span class="p">)</span> <span class="o">+</span> <span class="n">pi_nlogit</span> 
                <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_alpha_mu</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_alpha_mu</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span>
   
        <span class="k">return</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> </div>


<div class="viewcode-block" id="Decoder.decode">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Decoder.decode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">label_inp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decode latent and label inputs to distribution parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z : torch.Tensor</span>
<span class="sd">            Latent tensor of shape (batch_size, lat_dim).</span>
<span class="sd">        label_inp : torch.Tensor</span>
<span class="sd">            Label tensor of shape (batch_size, label_dim).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs : list of torch.Tensor</span>
<span class="sd">            [alpha, rho] or [alpha, rho, pi_nlogit].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;dataset&quot;</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_alpha</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_alpha</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label_inp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispersion</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>

        <span class="n">rho_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">rho_pre_hom</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">rho_pre</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span>
        <span class="n">rho_pre_nonhom</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">rho_pre</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_hom_genes</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_hom_genes</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dim</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">rho_pre_hom</span><span class="p">,</span> <span class="n">rho_pre_nonhom</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_ind</span><span class="p">]</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">rho</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">==</span> <span class="s1">&#39;zinb&#39;</span><span class="p">:</span>
            <span class="n">pi_nlogit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_nlogit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi_nlogit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>  </div>

    
<div class="viewcode-block" id="Decoder.decode_homologous">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Decoder.decode_homologous">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decode_homologous</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">label_inp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes the latent variables and label input into gene expression for homologous genes.</span>
<span class="sd">        This method is specifically used to asess and compare the log2-fold change between species.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z (Tensor): The latent space representation.</span>
<span class="sd">        label_inp (Tensor): The label input tensor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tensor: The decoded gene expression probabilities for homologous genes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">==</span> <span class="s1">&#39;zinb&#39;</span><span class="p">:</span>
            <span class="n">pi_nlogit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pi_hom</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pi_nlogit</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">])</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">rho_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">rho_hom</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">rho_pre</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pi_hom</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_distr</span> <span class="o">==</span> <span class="s1">&#39;nb&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">rho_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">rho_hom</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">rho_pre</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">homologous_genes</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rho_hom</span>  </div>


<div class="viewcode-block" id="Decoder.forward">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Decoder.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">label_inp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">library</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute mean negative log-likelihood loss.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z : torch.Tensor</span>
<span class="sd">            Latent representations.</span>
<span class="sd">        label_inp : torch.Tensor</span>
<span class="sd">            Labels.</span>
<span class="sd">        library : torch.Tensor</span>
<span class="sd">            Library size factors.</span>
<span class="sd">        x : torch.Tensor</span>
<span class="sd">            Observed data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Mean negative log-likelihood over batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">label_inp</span><span class="p">)</span>
        <span class="n">n_log_likeli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_nlog_likelihood</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">n_log_likeli</span>     </div>
</div>



<div class="viewcode-block" id="scSpecies">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">scSpecies</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The scSpecies cross-species architecture alignment framework built on scVI.</span>

<span class="sd">    This class implements end-to-end preprocessing, variational encoding, decoding, and alignment</span>
<span class="sd">    for a “context” dataset (e.g., mouse) and a “target” dataset (e.g., human). It supports:</span>
<span class="sd">    </span>
<span class="sd">    - Training scVI models on context and target (latent or intermediate alignment).</span>
<span class="sd">    - Library size encoding and negative-binomial / zero-inflated NB likelihoods.</span>
<span class="sd">    - Establishing a direct correspondece between traget can context cell via a likelihood-based similarity measure</span>
<span class="sd">    - Latent-space nearest-neighbor label transfer based on the similarity measure.</span>
<span class="sd">    - Log-fold-change computation of homologous genes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    device : str</span>
<span class="sd">        PyTorch device identifier (&#39;cpu&#39;, &#39;mps&#39; or &#39;cuda&#39;).</span>
<span class="sd">    mdata : mu.MuData</span>
<span class="sd">        Multi-modal container holding context and target AnnData objects, set up by the `create_mdata` class.</span>
<span class="sd">    directory : str</span>
<span class="sd">        Base path for saving model parameters, data, and figures.</span>
<span class="sd">    random_seed : int, default=369963</span>
<span class="sd">        Seed for NumPy and PyTorch RNGs.</span>
<span class="sd">    context_key : str, default=&#39;mouse&#39;</span>
<span class="sd">        Key in `mdata.mod` for the context dataset.</span>
<span class="sd">    target_key : str, default=&#39;human&#39;</span>
<span class="sd">        Key in `mdata.mod` for the target dataset.</span>
<span class="sd">    context_optimizer, target_optimizer : torch.optim.Optimizer classes</span>
<span class="sd">        Optimizer constructors for context and target models.</span>
<span class="sd">    context_hidden_dims_enc_outer, target_hidden_dims_enc_outer : list[int]</span>
<span class="sd">        Hidden layer sizes for the outer encoders.</span>
<span class="sd">    hidden_dims_enc_inner : list[int]</span>
<span class="sd">        Hidden layer sizes for the inner encoder.</span>
<span class="sd">    context_hidden_dims_l_enc, target_hidden_dims_l_enc : list[int]</span>
<span class="sd">        Hidden layer sizes for the library encoder.</span>
<span class="sd">    context_hidden_dims_dec, target_hidden_dims_dec : list[int]</span>
<span class="sd">        Hidden layer sizes for the decoder.</span>
<span class="sd">    context_layer_order, target_layer_order : list</span>
<span class="sd">        Layer specification lists for `create_structure`.</span>
<span class="sd">    b_s : int, default=128</span>
<span class="sd">        Batch size for training and inference.</span>
<span class="sd">    context_data_distr, target_data_distr : {&#39;nb&#39;, &#39;zinb&#39;}</span>
<span class="sd">        Observation models for counts.</span>
<span class="sd">    lat_dim : int, default=10</span>
<span class="sd">        Dimensionality of the latent space.</span>
<span class="sd">    context_dispersion, target_dispersion : {&#39;dataset&#39;, &#39;batch&#39;, &#39;cell&#39;}</span>
<span class="sd">        Dispersion parameterization strategy.</span>
<span class="sd">    alignment : {&#39;inter&#39;, &#39;latent&#39;}</span>
<span class="sd">        Alignment mode between context and target. Either at the outer encoder output space or at the latent space.</span>
<span class="sd">    k_neigh : int, default=25</span>
<span class="sd">        Number of neighbors candidates for alignment from the data-level NNS.</span>
<span class="sd">    top_percent : float, default=20</span>
<span class="sd">        Percentile cutoff for selecting top-agreement neighbors.</span>
<span class="sd">    context_beta_*, target_beta_*, eta_* : floats and ints</span>
<span class="sd">        Schedules for KL and alignment weight ramps.</span>
<span class="sd">    use_lib_enc : bool, default=True</span>
<span class="sd">        Whether to include a library-size encoder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
 
<div class="viewcode-block" id="scSpecies.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">mdata</span><span class="p">:</span> <span class="n">mu</span><span class="o">.</span><span class="n">MuData</span><span class="p">,</span> 
            <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  
            <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">369963</span><span class="p">,</span> 

            <span class="n">context_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span> 
            <span class="n">target_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span>      

            <span class="n">context_optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
            <span class="n">target_optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>   

            <span class="n">context_hidden_dims_enc_outer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">],</span>
            <span class="n">target_hidden_dims_enc_outer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">],</span>
            <span class="n">hidden_dims_enc_inner</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">],</span>
            <span class="n">context_hidden_dims_l_enc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">],</span>
            <span class="n">target_hidden_dims_l_enc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">],</span>
            <span class="n">context_hidden_dims_dec</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
            <span class="n">target_hidden_dims_dec</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
            <span class="n">lat_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

            <span class="n">context_layer_order</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_norm&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;act&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)],</span>
            <span class="n">target_layer_order</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_norm&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;act&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)],</span><span class="c1">#</span>
            <span class="n">use_lib_enc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  

            <span class="n">b_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>    

            <span class="n">context_data_distr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;zinb&#39;</span><span class="p">,</span>
            <span class="n">target_data_distr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;zinb&#39;</span><span class="p">,</span>

            <span class="n">context_dispersion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span>
            <span class="n">target_dispersion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span>

            <span class="n">alignment</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s1">&#39;inter&#39;</span><span class="p">,</span>
            <span class="n">k_neigh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
            <span class="n">top_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>

            <span class="n">context_beta_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>                
            <span class="n">context_beta_max</span><span class="p">:</span> <span class="nb">float</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">context_beta_epochs_raise</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
            <span class="n">target_beta_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>                
            <span class="n">target_beta_max</span><span class="p">:</span> <span class="nb">float</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">target_beta_epochs_raise</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
            <span class="n">eta_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">eta_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
            <span class="n">eta_epochs_raise</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>    
        <span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">context_likeli_hist_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_likeli_hist_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span> <span class="o">=</span> <span class="n">mdata</span>

        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span> 
            <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">hom_ind_context</span><span class="p">,</span> <span class="n">hom_ind_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;var_names_transl&#39;</span><span class="p">],</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    

        <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">,</span> 
            <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span> 
            <span class="s1">&#39;inter_dim&#39;</span><span class="p">:</span> <span class="n">hidden_dims_enc_inner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;lat_dim&#39;</span><span class="p">:</span> <span class="n">lat_dim</span><span class="p">,</span>
            <span class="s1">&#39;b_s&#39;</span><span class="p">:</span> <span class="n">b_s</span><span class="p">,</span>    
            <span class="s1">&#39;alignment&#39;</span><span class="p">:</span> <span class="n">alignment</span><span class="p">,</span>   
            <span class="s1">&#39;use_lib_enc&#39;</span><span class="p">:</span> <span class="n">use_lib_enc</span>            
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;context_key&#39;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">,</span>
            <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">context_optimizer</span><span class="p">,</span>
            <span class="s1">&#39;homologous_genes&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">hom_ind_context</span><span class="p">),</span>
            <span class="s1">&#39;data_dim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">n_vars</span><span class="p">,</span>
            <span class="s1">&#39;label_dim&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;batch_label_enc&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span>  
            <span class="s1">&#39;lib_mu_add&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;library_log_mean&#39;</span><span class="p">]),</span><span class="mi">5</span><span class="p">),</span>    
            <span class="s1">&#39;dims_enc_outer&#39;</span><span class="p">:</span> <span class="n">context_hidden_dims_enc_outer</span><span class="p">,</span>
            <span class="s1">&#39;dims_enc_inner&#39;</span><span class="p">:</span> <span class="n">hidden_dims_enc_inner</span><span class="p">,</span>
            <span class="s1">&#39;dims_l_enc&#39;</span><span class="p">:</span> <span class="n">context_hidden_dims_l_enc</span><span class="p">,</span>
            <span class="s1">&#39;lat_dim&#39;</span><span class="p">:</span> <span class="n">lat_dim</span><span class="p">,</span>
            <span class="s1">&#39;dims_dec&#39;</span><span class="p">:</span> <span class="n">context_hidden_dims_dec</span><span class="p">,</span>
            <span class="s1">&#39;layer_order&#39;</span><span class="p">:</span> <span class="n">context_layer_order</span><span class="p">,</span>
            <span class="s1">&#39;data_distr&#39;</span><span class="p">:</span> <span class="n">context_data_distr</span><span class="p">,</span>
            <span class="s1">&#39;dispersion&#39;</span><span class="p">:</span> <span class="n">context_dispersion</span><span class="p">,</span>
            <span class="s1">&#39;beta_start&#39;</span><span class="p">:</span> <span class="n">context_beta_start</span><span class="p">,</span> 
            <span class="s1">&#39;beta_max&#39;</span><span class="p">:</span> <span class="n">context_beta_max</span><span class="p">,</span>   
            <span class="s1">&#39;beta_epochs_raise&#39;</span><span class="p">:</span> <span class="n">context_beta_epochs_raise</span><span class="p">,</span>  
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">context_beta_start</span><span class="p">,</span> 
        <span class="p">}</span>     

        <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;target_key&#39;</span><span class="p">:</span> <span class="n">target_key</span><span class="p">,</span> 
            <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">target_optimizer</span><span class="p">,</span>
            <span class="s1">&#39;homologous_genes&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">hom_ind_target</span><span class="p">),</span>
            <span class="s1">&#39;data_dim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">n_vars</span><span class="p">,</span>
            <span class="s1">&#39;label_dim&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;batch_label_enc&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> 
            <span class="s1">&#39;lib_mu_add&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;library_log_mean&#39;</span><span class="p">]),</span><span class="mi">5</span><span class="p">),</span> 
            <span class="s1">&#39;dims_enc_outer&#39;</span><span class="p">:</span> <span class="n">target_hidden_dims_enc_outer</span><span class="p">,</span>   
            <span class="s1">&#39;dims_enc_inner&#39;</span><span class="p">:</span> <span class="n">hidden_dims_enc_inner</span><span class="p">,</span>
            <span class="s1">&#39;dims_l_enc&#39;</span><span class="p">:</span> <span class="n">target_hidden_dims_l_enc</span><span class="p">,</span>
            <span class="s1">&#39;lat_dim&#39;</span><span class="p">:</span> <span class="n">lat_dim</span><span class="p">,</span>
            <span class="s1">&#39;dims_dec&#39;</span><span class="p">:</span> <span class="n">target_hidden_dims_dec</span><span class="p">,</span>
            <span class="s1">&#39;layer_order&#39;</span><span class="p">:</span> <span class="n">target_layer_order</span><span class="p">,</span>          
            <span class="s1">&#39;data_distr&#39;</span><span class="p">:</span> <span class="n">target_data_distr</span><span class="p">,</span>
            <span class="s1">&#39;dispersion&#39;</span><span class="p">:</span> <span class="n">target_dispersion</span><span class="p">,</span>            
            <span class="s1">&#39;beta_start&#39;</span><span class="p">:</span> <span class="n">target_beta_start</span><span class="p">,</span>                                      
            <span class="s1">&#39;beta_max&#39;</span><span class="p">:</span> <span class="n">target_beta_max</span><span class="p">,</span>     
            <span class="s1">&#39;beta_epochs_raise&#39;</span><span class="p">:</span> <span class="n">target_beta_epochs_raise</span><span class="p">,</span>              
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">target_beta_start</span><span class="p">,</span>          
            <span class="s1">&#39;k_neigh&#39;</span><span class="p">:</span> <span class="n">k_neigh</span><span class="p">,</span>
            <span class="s1">&#39;top_percent&#39;</span><span class="p">:</span> <span class="n">top_percent</span><span class="p">,</span>            
            <span class="s1">&#39;eta_start&#39;</span><span class="p">:</span> <span class="n">eta_start</span><span class="p">,</span>     
            <span class="s1">&#39;eta_max&#39;</span><span class="p">:</span> <span class="n">eta_max</span><span class="p">,</span>
            <span class="s1">&#39;eta_epochs_raise&#39;</span><span class="p">:</span> <span class="n">eta_epochs_raise</span><span class="p">,</span>             
            <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="n">eta_start</span><span class="p">,</span>  
        <span class="p">}</span>     

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;dims_enc_outer&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;dims_enc_outer&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Context and target dims_enc_outer must have the same output dimensions.&quot;</span><span class="p">)</span>       

        <span class="bp">self</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>    </div>


<div class="viewcode-block" id="scSpecies.get_batch">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.get_batch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_batch</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">array</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">],</span>
            <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">perm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice out a minibatch and move to device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        array : Tensor or sequence</span>
<span class="sd">            Data to batch (e.g., features, labels, indices).</span>
<span class="sd">        step : int</span>
<span class="sd">            Batch index.</span>
<span class="sd">        perm : sequence of int, optional</span>
<span class="sd">            Permutation for shuffling; if None, uses contiguous slices.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Number of samples per batch; defaults to `self.config_dict[&#39;b_s&#39;]`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tensor or sequence</span>
<span class="sd">            The selected batch, on the configured device if a Tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">bs</span>
        <span class="n">end</span>   <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">bs</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="k">if</span> <span class="n">perm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="n">batch</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">batch</span></div>


<div class="viewcode-block" id="scSpecies.initialize">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">initialize</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>
        <span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate or reinstantiate context and/or target encoder and decoder modules.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        initialize : {&#39;context&#39;, &#39;context_decoder&#39;, &#39;target&#39;, &#39;both&#39;}, default=&#39;both&#39;</span>
<span class="sd">            Which sub-model(s) to initialize.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="n">initialize</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;context_decoder&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing context scVI model.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span> 
            <span class="n">model_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">initialize</span> <span class="o">!=</span> <span class="s1">&#39;context_decoder&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span> <span class="o">=</span> <span class="n">Encoder_inner</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">],</span>  <span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span> <span class="o">=</span> <span class="n">Encoder_outer</span><span class="p">(</span><span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>     
                <span class="n">model_params</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span> <span class="o">=</span> <span class="n">Library_encoder</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">],</span> <span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>    
                    <span class="n">model_params</span> <span class="o">+=</span>  <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;context_lib_encoder&#39;</span>                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">](</span><span class="n">model_params</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;context_encoder_inner&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;context_encoder_outer&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;context_decoder&#39;</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;context_optimizer&#39;</span>   

        <span class="k">if</span> <span class="n">initialize</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing target scVI model.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span> <span class="o">=</span> <span class="n">Encoder_outer</span><span class="p">(</span><span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  
            <span class="n">model_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span> <span class="o">=</span> <span class="n">Library_encoder</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">],</span> <span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>       
                <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>                    
                <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;target_lib_encoder&#39;</span>      
                <span class="n">model_params</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;latent&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span> <span class="o">=</span> <span class="n">Encoder_inner</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">],</span>  <span class="n">param_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                <span class="n">model_params</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inter&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">target_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">](</span><span class="n">model_params</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;target_encoder_inner&#39;</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;target_encoder_outer&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;target_decoder&#39;</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">target_optimizer</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;target_optimizer&#39;</span>   </div>



<div class="viewcode-block" id="scSpecies.create_directory">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.create_directory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_directory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create project subdirectories for parameters, data, and figures.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory : str</span>
<span class="sd">            Base output directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dat_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;figures&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created directory &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="scSpecies.pkl">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.pkl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="scSpecies.pth">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.pth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="scSpecies.opt">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.opt&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="scSpecies.hmu">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.hmu">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hmu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.h5mu&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="scSpecies.save">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">models</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> 
            <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize model configuration, optimizers, and context and/or target scVI weights to disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        models : {&#39;context&#39;, &#39;target&#39;, &#39;both&#39;}</span>
<span class="sd">            Which sub-models to save.</span>
<span class="sd">        save_key : str</span>
<span class="sd">            Suffix for filenames.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;config_dict.pkl&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>            
                <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="p">]</span>
                
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkl</span><span class="p">(</span><span class="s1">&#39;context_config&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;context_optimizer&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="p">]</span>
                
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkl</span><span class="p">(</span><span class="s1">&#39;target_config&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;target_optimizer&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pth</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>  </div>


<div class="viewcode-block" id="scSpecies.save_mdata">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.save_mdata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_mdata</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">):</span> 
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the assembled MuData object to `.h5mu`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save_key : str</span>
<span class="sd">            Suffix for the data filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hmu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat_dir</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="scSpecies.load">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">models</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> 
            <span class="n">save_key</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="p">):</span> 
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load previously saved configs, optimizers, and weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        models : {&#39;context&#39;,&#39;target&#39;,&#39;both&#39;}</span>
<span class="sd">        save_key : str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prm_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;config_dict.pkl&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span><span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkl</span><span class="p">(</span><span class="s1">&#39;context_config&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span><span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkl</span><span class="p">(</span><span class="s1">&#39;target_config&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span><span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;context_optimizer&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;target_optimizer&#39;</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            


        <span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">models</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                <span class="n">model_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pth</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">save_key</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])))</span>    
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inter&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span>   </div>


<div class="viewcode-block" id="scSpecies.most_frequent">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.most_frequent">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">most_frequent</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the modal value of a 1D array.</span>
<span class="sd">        Helper for the `label_transfer` function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arr : array-like</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        element</span>
<span class="sd">            The value occurring most often.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span></div>


<div class="viewcode-block" id="scSpecies.transfer_info">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.transfer_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transfer_info</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>     
            <span class="n">target_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">context_obs_transfer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate similarity scores for a specific target cell specified by its index in `self.mdata[target_key].X`</span>
<span class="sd">        and all context cells. Transfers labels specifies in context_obs_transfer. Returns a dataframe </span>
<span class="sd">        of context cells sorted by similarity scores. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_ind : int</span>
<span class="sd">            Target cell indices.</span>
<span class="sd">        context_obs_transfer : str or List of str</span>
<span class="sd">            Observation key from context dataset to return as columns in the outpt (e.g., &#39;cell_type&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataFrame</span>
<span class="sd">            Context labels, source indices, and similarity scores with the specified target cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_obs_transfer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">context_obs_transfer</span> <span class="o">=</span> <span class="p">[</span><span class="n">context_obs_transfer</span><span class="p">]</span>

        <span class="n">context_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_metric</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">target_ind</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">context_inds</span><span class="p">)</span>

        <span class="n">df_neigbor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">)]</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">context_obs_transfer</span><span class="p">]</span>
        <span class="n">df_neigbor</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">))</span>
        <span class="n">df_neigbor</span><span class="p">[</span><span class="s1">&#39;similarity_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">similarities</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">df_neigbor</span></div>


<div class="viewcode-block" id="scSpecies.similarity_metric">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.similarity_metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_metric</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target_ind</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">context_ind</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">b_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">b_sc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">display</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute negative log-likelihood based similarity scores for target and context cells specified by their indices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_ind : array of integers </span>
<span class="sd">            Traget cell indices in `self.mdata[target_key].X` shape (n_target, 1)</span>
<span class="sd">        context_ind : array of integers </span>
<span class="sd">            Context cell neighbors in `self.mdata[context_key].X` shape (n_target, k). </span>
<span class="sd">            Calculates the similarity of k candidates for a specific entry in the first axis.</span>
<span class="sd">        b_s : int, optional</span>
<span class="sd">            Batch size for target.</span>
<span class="sd">        b_sc : int, optional</span>
<span class="sd">            Chunk size for context neighbors.</span>
<span class="sd">        display : bool    </span>
<span class="sd">            If True, prints progress.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        similarities : ndarray </span>
<span class="sd">            Contains the similarity scores between the context cells and their k candidates, shape (n_target, k).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">b_s</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">b_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">b_sc</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b_sc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">25</span><span class="o">/</span><span class="n">b_s</span><span class="p">)</span>    

        <span class="n">k_neigh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">target_ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">b_s</span><span class="p">))</span> <span class="c1"># +1e-10</span>
        <span class="n">steps_c_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">k_neigh</span><span class="o">/</span><span class="n">b_sc</span><span class="p">))</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>   

                <span class="k">if</span> <span class="n">display</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Calculate similarity metric. Step </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

                <span class="n">target_ind_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">target_ind</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">b_s</span><span class="p">)</span>
                <span class="n">target_adata_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]][</span><span class="n">target_ind_batch</span><span class="p">]</span>
                <span class="n">target_x_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_adata_batch</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  
                <span class="n">target_s_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_adata_batch</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;batch_label_enc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  
                <span class="n">target_l_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_adata_batch</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_mu&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  
                <span class="n">sim_batch_c</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">step_c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_c_ind</span><span class="p">):</span>
                    <span class="n">context_ind_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">context_ind</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">b_s</span><span class="p">)[:,</span> <span class="n">step_c</span><span class="o">*</span><span class="n">b_sc</span><span class="p">:(</span><span class="n">step_c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">b_sc</span><span class="p">]</span>
                    
                    <span class="n">s_interl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">target_s_batch</span><span class="p">,</span> <span class="n">repeats</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">l_interl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">target_l_batch</span><span class="p">,</span> <span class="n">repeats</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">x_interl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">target_x_batch</span><span class="p">,</span> <span class="n">repeats</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                
                    <span class="n">context_ind_batch_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_x_batch</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="n">context_z_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">][</span><span class="n">context_ind_batch_sq</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span> 

                    <span class="n">outp_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">context_z_batch</span><span class="p">,</span> <span class="n">s_interl</span><span class="p">)</span>
                    <span class="n">outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">calc_nlog_likelihood</span><span class="p">(</span><span class="n">outp_neighbors</span><span class="p">,</span> <span class="n">l_interl</span><span class="p">,</span> <span class="n">x_interl</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">target_x_batch</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
                    <span class="n">sim_batch_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outp</span><span class="p">)</span>

                <span class="n">sim_batch_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sim_batch_c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">target_z_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_adata_batch</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  
                <span class="n">outp_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">target_z_batch</span><span class="p">,</span> <span class="n">target_s_batch</span><span class="p">)</span>
                <span class="n">sim_batch_c</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">calc_nlog_likelihood</span><span class="p">(</span><span class="n">outp_target</span><span class="p">,</span> <span class="n">target_l_batch</span><span class="p">,</span> <span class="n">target_x_batch</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 

                <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_batch_c</span><span class="p">)</span>

            <span class="n">similarities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">similarities</span></div>



<div class="viewcode-block" id="scSpecies.ret_pred_df">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.ret_pred_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ret_pred_df</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pred_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">target_label_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">context_label_key</span><span class="p">:</span> <span class="nb">str</span>    
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a normalized confusion matrix (%) and balanced accuracy for label transfer.</span>

<span class="sd">        This evaluates how well the predicted context-derived labels match the true labels</span>
<span class="sd">        on the target dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pred_key : str</span>
<span class="sd">            Key in `self.mdata.mod[target_key].obs` under which predicted labels are stored.</span>
<span class="sd">        target_label_key : str</span>
<span class="sd">            Key in `self.mdata.mod[target_key].obs` for the ground-truth labels.</span>
<span class="sd">        context_label_key : str</span>
<span class="sd">            Key in `self.mdata.mod[context_key].obs` for the reference context labels.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Confusion matrix (in percent) with</span>
<span class="sd">            - index: sorted labels of `target_label_key`,</span>
<span class="sd">            - columns: sorted labels of `context_label_key`,</span>
<span class="sd">            - values: percentage of cells with true label = row and predicted label = column.</span>
<span class="sd">        bas : float</span>
<span class="sd">            Balanced accuracy score computed only over the subset of cells whose true labels</span>
<span class="sd">            also appear in the context set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">predicted_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">pred_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">target_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_label_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">context_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_label_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">unique_target_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_labels</span><span class="p">)</span>
        <span class="n">unique_context_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">context_labels</span><span class="p">)</span>

        <span class="n">joint_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">context_labels</span><span class="p">,</span> <span class="n">target_labels</span><span class="p">)</span>
        <span class="n">joint_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cell_label</span> <span class="ow">in</span> <span class="n">joint_labels</span> <span class="k">for</span> <span class="n">cell_label</span> <span class="ow">in</span> <span class="n">target_labels</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bas</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">target_labels</span><span class="p">[</span><span class="n">joint_ind</span><span class="p">],</span> <span class="n">predicted_labels</span><span class="p">[</span><span class="n">joint_ind</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">unique_target_labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">unique_context_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">true_lbl</span><span class="p">,</span> <span class="n">pred_lbl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_labels</span><span class="p">,</span> <span class="n">predicted_labels</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">true_lbl</span><span class="p">,</span> <span class="n">pred_lbl</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">bas</span></div>


<div class="viewcode-block" id="scSpecies.similarity_metric_on_latent_space">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.similarity_metric_on_latent_space">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">similarity_metric_on_latent_space</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">precompute_neighbors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute similarity scores for the whole context and target dataset pairs.</span>
<span class="sd">        Either for a precomputed set of neighbors based on the results of a latent spce neighborhood search to speed up computation</span>
<span class="sd">        or the whole dataset. (Should only be done for small datasets.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        precompute_neighbors : bool</span>
<span class="sd">            If True precomutes a set of 250 euclidean neighbors on the aligned latent space.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        similarities : ndarray of shape (target.n_obs, 250) or (target.n_obs, context.n_obs)</span>
<span class="sd">        context_ind : ndarray of shape (target.n_obs, 250) or (target.n_obs, context.n_obs)</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="n">precompute_neighbors</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span> 
            <span class="n">n_obs_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span>
            <span class="n">n_obs_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span>

            <span class="n">n_evals</span> <span class="o">=</span> <span class="n">n_obs_context</span> <span class="o">*</span> <span class="n">n_obs_target</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning, not precomputing neighbors on the latent space will lead to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;a total of </span><span class="si">{</span><span class="n">n_evals</span><span class="si">}</span><span class="s2"> decoder evaluations. Proceed? [y/N] &quot;</span>
            <span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set precompute_neighbors to true.&quot;</span><span class="p">)</span>
                <span class="n">precompute_neighbors</span> <span class="o">==</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span> 
                <span class="n">context_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_obs_target</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_obs_context</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>    

        <span class="k">if</span> <span class="n">precompute_neighbors</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pre-computing latent space NNS with 250 neighbors using the euclidean distance.&#39;</span><span class="p">)</span>

            <span class="n">neigh</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
            <span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">])</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">context_ind</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">])</span>

        <span class="n">target_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span><span class="p">)</span>    
        <span class="n">similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_metric</span><span class="p">(</span><span class="n">target_ind</span><span class="p">,</span> <span class="n">context_ind</span><span class="p">,</span> <span class="n">b_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_sc</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">similarities</span><span class="p">,</span> <span class="n">context_ind</span></div>


<div class="viewcode-block" id="scSpecies.label_transfer">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.label_transfer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">label_transfer</span><span class="p">(</span>    
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">context_obs_keys</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">top_neigh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
            <span class="n">write_sim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign context-derived labels via similarity scores to each target cell by majority vote among its top candidates.</span>

<span class="sd">        For each observation key in `context_obs_keys`, finds the `top_neigh` most similar context</span>
<span class="sd">        cells (based on decoder likelihood in latent space), takes the most frequent label among</span>
<span class="sd">        those neighbors, and writes it into `self.mdata.mod[target_key].obs[&#39;pred_sim_&lt;obs_key&gt;&#39;]`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        context_obs_keys : sequence of str</span>
<span class="sd">            One or more keys in `self.mdata.mod[context_key].obs` whose values to transfer.</span>
<span class="sd">        top_neigh : int, default=25</span>
<span class="sd">            Number of nearest neighbors to consider for the majority vote.</span>
<span class="sd">        write_sim : bool, default=False</span>
<span class="sd">            If True, also stores raw similarity scores and neighbor indices in</span>
<span class="sd">            `self.mdata.mod[target_key].obsm[&#39;similarities&#39;]` and</span>
<span class="sd">            `[&#39;similarities_ind&#39;]`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">similarities</span><span class="p">,</span> <span class="n">context_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_metric_on_latent_space</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">write_sim</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;similarities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_labels</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;similarities_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_ind</span> 

        <span class="k">for</span> <span class="n">obs_key</span> <span class="ow">in</span> <span class="n">context_obs_keys</span><span class="p">:</span>
            <span class="n">context_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">target_n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span>
            <span class="n">pred_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">most_frequent</span><span class="p">(</span><span class="n">context_labels</span><span class="p">[</span><span class="n">context_ind</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">[</span><span class="n">i</span><span class="p">])]][:</span><span class="n">top_neigh</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">target_n_obs</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;pred_sim_&#39;</span><span class="o">+</span><span class="n">obs_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_labels</span> </div>


<div class="viewcode-block" id="scSpecies.average_slices">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.average_slices">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">average_slices</span><span class="p">(</span>    
            <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">slice_sizes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the mean of consecutive subarrays of a flat 2D array.</span>
<span class="sd">        Helper for `compute_logfold_change`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        array : ndarray, shape (sum(slice_sizes), n_features)</span>
<span class="sd">            The concatenated data.</span>
<span class="sd">        slice_sizes : sequence of int</span>
<span class="sd">            Positive integers that sum to `array.shape[0]`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stacked_means : ndarray, shape (len(slice_sizes), n_features)</span>
<span class="sd">            The mean of each slice.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">averages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">slice_sizes</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span>
            <span class="n">slice_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">averages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slice_avg</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">averages</span><span class="p">)</span></div>


<div class="viewcode-block" id="scSpecies.filter_outliers">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.filter_outliers">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_outliers</span><span class="p">(</span>    
            <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify inlier and outlier rows based on the Mahalanobis distance.</span>

<span class="sd">        Computes the Mahalanobis distance of each row in `data` from the multivariate mean,</span>
<span class="sd">        uses a chi-squared cutoff at the given `confidence_level`, and returns boolean masks.</span>
<span class="sd">        Helper for `compute_logfold_change`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : ndarray, shape (n_samples, n_features)</span>
<span class="sd">            Input points in feature space.</span>
<span class="sd">        confidence_level : float, default=0.9</span>
<span class="sd">            Threshold percentile for declaring a point an inlier.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        inlier_mask : ndarray of bool, shape (n_samples,)</span>
<span class="sd">            True for rows whose Mahalanobis distance is below the threshold.</span>
<span class="sd">        outlier_mask : ndarray of bool, shape (n_samples,)</span>
<span class="sd">            True for rows whose distance exceeds the threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_centered</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">mean</span>
        <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data_centered</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">data_centered</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">data_centered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cov_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>

        <span class="n">m_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data_centered</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">)</span> <span class="o">*</span> <span class="n">data_centered</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">confidence_level</span><span class="p">,</span> <span class="n">df</span><span class="p">))</span>

        <span class="n">filtered_data_ind</span> <span class="o">=</span> <span class="n">m_dist</span> <span class="o">&lt;</span> <span class="n">threshold</span>
        <span class="n">outlier_ind</span> <span class="o">=</span> <span class="n">m_dist</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
        <span class="k">return</span> <span class="n">filtered_data_ind</span><span class="p">,</span> <span class="n">outlier_ind</span></div>



<div class="viewcode-block" id="scSpecies.generate_homologous_samples">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.generate_homologous_samples">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_homologous_samples</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
            <span class="n">target_cell_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">b_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decode homologous normalized expression profiles for context and target species by Monte Carlo sampling.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_cell_key : str or None</span>
<span class="sd">            Column name in `.obs` specifying inferred cell type labels for the target dataset;</span>
<span class="sd">        samples : int, default=5000</span>
<span class="sd">            Total number of decoded samples to return per cell type.</span>
<span class="sd">        b_s : int, default=128</span>
<span class="sd">            Batch size for decoding iterations.</span>
<span class="sd">        confidence_level : float, default=0.9</span>
<span class="sd">            Quantile threshold used in `filter_outliers` to remove extreme latent embeddings.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        target_rho_dict : dict of str to ndarray of shape (samples, genes)</span>
<span class="sd">            Decoded normalized expression (`rho`) for shared cell types in the target species.</span>
<span class="sd">        context_rho_dict : dict of str to ndarray of shape (samples, genes)</span>
<span class="sd">            Decoded normalized expression (`rho`) for shared cell types in the context species.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>         

        <span class="n">context_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]</span>
        <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]</span>
        <span class="n">context_cell_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_cell_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_cell_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>
        <span class="n">context_batch_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;batch_key&#39;</span><span class="p">]</span>
        <span class="n">target_batch_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;batch_key&#39;</span><span class="p">]</span>   

        <span class="k">if</span> <span class="n">target_cell_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target cell labels must be known or transferred from the context dataset first and provided as function input.&quot;</span><span class="p">)</span> 

        <span class="n">context_cell_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">context_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">context_cell_labels</span><span class="p">)</span>

        <span class="n">target_cell_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">target_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_cell_labels</span><span class="p">)</span>
        <span class="n">target_cell_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_cell_labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>

        <span class="n">context_batch_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;dataset_batch_key&#39;</span><span class="p">]</span>
        <span class="n">target_batch_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;dataset_batch_key&#39;</span><span class="p">]</span>
        
        <span class="n">context_batch_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">target_batch_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">context_enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
        <span class="n">context_enc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">context_batch_labels</span><span class="p">)</span>

        <span class="n">target_enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
        <span class="n">target_enc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">target_batch_labels</span><span class="p">)</span>

        <span class="n">context_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_cell_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>
        <span class="n">context_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>
        <span class="n">context_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">context_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>
        <span class="n">context_batches</span><span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">context_batch_labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target_cell_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">joint_cell_types</span> <span class="o">=</span> <span class="n">context_cell_types</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_cell_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">target_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_cell_labels</span><span class="p">)</span>
            <span class="n">joint_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">context_cell_types</span><span class="p">,</span> <span class="n">target_cell_types</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">target_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
            <span class="n">target_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
            <span class="n">target_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">target_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
            <span class="n">target_batches</span><span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_batch_labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">context_rho_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">target_rho_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">joint_cell_types</span><span class="p">:</span>
            <span class="n">adata_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_cell_index</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]]</span>

            <span class="n">filtered_data_ind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_outliers</span><span class="p">(</span><span class="n">adata_target</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">],</span> <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">)</span>
            <span class="n">adata_target</span> <span class="o">=</span> <span class="n">adata_target</span><span class="p">[</span><span class="n">filtered_data_ind</span><span class="p">]</span>      

            <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">adata_target</span><span class="o">.</span><span class="n">n_obs</span><span class="o">/</span><span class="n">b_s</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>    
            <span class="n">iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">samples</span><span class="o">/</span><span class="n">adata_target</span><span class="o">.</span><span class="n">n_obs</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">context_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>    
                <span class="n">target_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  

                <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>   
                        <span class="n">batch_adata</span> <span class="o">=</span> <span class="n">adata_target</span><span class="p">[</span><span class="n">step</span><span class="o">*</span><span class="n">b_s</span><span class="p">:(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">b_s</span><span class="p">]</span>
                        <span class="n">context_cell_type</span> <span class="o">=</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;dataset_cell_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                        <span class="n">target_cell_type</span> <span class="o">=</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;dataset_cell_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> 

                        <span class="n">context_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_type</span><span class="p">])</span>
                        <span class="n">target_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_type</span><span class="p">])</span>
                    
                        <span class="n">context_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">context_labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                        <span class="n">target_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>            

                        <span class="n">context_ind_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_type</span><span class="p">])</span>
                        <span class="n">target_ind_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_type</span><span class="p">])</span>

                        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_sig&#39;</span><span class="p">])</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_sig&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> 

                        <span class="n">context_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)])</span>
                        <span class="n">target_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_ind_batch</span><span class="p">)])</span>

                        <span class="n">context_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">context_z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                        <span class="n">target_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>

                        <span class="n">context_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">decode_homologous</span><span class="p">(</span><span class="n">context_z</span><span class="p">,</span> <span class="n">context_labels</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="n">context_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_slices</span><span class="p">(</span><span class="n">context_rho</span><span class="p">,</span> <span class="n">context_ind_batch</span><span class="p">)</span>

                        <span class="n">target_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">decode_homologous</span><span class="p">(</span><span class="n">target_z</span><span class="p">,</span> <span class="n">target_labels</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="n">target_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_slices</span><span class="p">(</span><span class="n">target_rho</span><span class="p">,</span> <span class="n">target_ind_batch</span><span class="p">)</span>

                        <span class="n">context_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_rho</span><span class="p">)</span>
                        <span class="n">target_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_rho</span><span class="p">)</span>

            <span class="n">target_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">])[:</span><span class="n">samples</span><span class="p">]</span>
            <span class="n">context_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">context_rho_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">])[:</span><span class="n">samples</span><span class="p">]</span>  

        <span class="k">return</span> <span class="n">target_rho_dict</span><span class="p">,</span> <span class="n">context_rho_dict</span></div>



<div class="viewcode-block" id="scSpecies.compute_logfold_change">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.compute_logfold_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_logfold_change</span><span class="p">(</span>    
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">eval_cell_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="n">lfc_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
            <span class="n">target_cell_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>            
            <span class="n">b_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monte Carlo estimation of per-gene Log2-fold-changes and associated probabilities.</span>

<span class="sd">        For each specified cell type (or the intersection of context/target types), samples</span>
<span class="sd">        from the scVI posterior, computes the ratio of target vs. context expression for each</span>
<span class="sd">        homologous gene, and aggregates:</span>
<span class="sd">        - Median Log2-fold-change (on normalized decoder space),</span>
<span class="sd">        - Probability(abs(Log2Fc) &gt; lfc_delta),</span>
<span class="sd">        - Mean gene expression on normalized decoder space and NB parameter space.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eval_cell_types : sequence of str, optional</span>
<span class="sd">            Cell types to include; defaults to the intersection of context and target types.</span>
<span class="sd">        eps : float, default=1e-6</span>
<span class="sd">            Small constant added before log to prevent small gene expression patterns from returning large LFC values.</span>
<span class="sd">        lfc_delta : float, default=1</span>
<span class="sd">            Threshold for computing the probability of large fold-changes.</span>
<span class="sd">        target_cell_key : str or None</span>
<span class="sd">            Column name in `.obs` specifying inferred cell type labels for the target dataset;            </span>
<span class="sd">        samples : int, default=50000</span>
<span class="sd">            Total number of Monte Carlo draws per cell.</span>
<span class="sd">        b_s : int, default=128</span>
<span class="sd">            Batch size for sampling iterations.</span>
<span class="sd">        confidence_level : float, default=0.9</span>
<span class="sd">            Outlier filtering threshold for latent space.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lfc_dict : dict of str to pd.Dataframe</span>
<span class="sd">            Dictionary with cell-wise data frames containing the keys:</span>
<span class="sd">            - &#39;rho_median_context&#39; : Median context normalized gene expression, </span>
<span class="sd">            - &#39;mu_median_context&#39; : Median context expected value gene expression,  </span>
<span class="sd">            - &#39;rho_median_target&#39; : Median target normalized gene expression,  </span>
<span class="sd">            - &#39;mu_median_target&#39; : Median target expected value gene expression,  </span>
<span class="sd">            - &#39;lfc&#39; : Median Log2 fold-change of the relative expression parameter rho,</span>
<span class="sd">            - &#39;p&#39; : Probability of Log2 fold-change values greater than lfc_delta,</span>
<span class="sd">            - &#39;lfc_rand&#39; : Median Log2 fold-change of the relative expression parameter rho on permuted data,</span>
<span class="sd">            - &#39;p_rand&#39; : Probability of Log2 fold-change values greater than lfc_delta  on permuted data. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">context_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]</span>
        <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]</span>
        <span class="n">context_cell_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_cell_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_cell_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>
        <span class="n">context_batch_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;batch_key&#39;</span><span class="p">]</span>
        <span class="n">target_batch_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;batch_key&#39;</span><span class="p">]</span>    

        <span class="k">if</span> <span class="n">target_cell_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target cell labels must be known or transferred from the context dataset first and provided as function input.&quot;</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>         
                            
        <span class="n">target_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;homologous_genes&#39;</span><span class="p">])</span>
        <span class="n">target_gene_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">target_ind</span><span class="p">]</span>

        <span class="n">context_cell_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">context_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">context_cell_labels</span><span class="p">)</span>
        <span class="n">context_cell_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">context_cell_labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>

        <span class="n">target_cell_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">target_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_cell_labels</span><span class="p">)</span>
        <span class="n">target_cell_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_cell_labels</span> <span class="o">==</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
        
        <span class="n">context_batch_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">target_batch_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">context_enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
        <span class="n">context_enc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">context_batch_labels</span><span class="p">)</span>

        <span class="n">target_enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
        <span class="n">target_enc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">target_batch_labels</span><span class="p">)</span>

        <span class="n">context_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_cell_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">context_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>
        <span class="n">context_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>
        <span class="n">context_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">context_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">}</span>
        <span class="n">context_batches</span><span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">context_batch_labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">target_cell_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">target_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_cell_labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eval_cell_types</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> 
            <span class="n">eval_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">context_cell_types</span><span class="p">,</span> <span class="n">target_cell_types</span><span class="p">)</span>

        <span class="n">target_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
        <span class="n">target_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
        <span class="n">target_batches</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="p">:</span> <span class="n">target_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">}</span>
        <span class="n">target_batches</span><span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target_batch_labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">random_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_gene_names</span><span class="p">))</span>

        <span class="n">lfc_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">eval_cell_types</span><span class="p">:</span>
            <span class="n">adata_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">][</span><span class="n">context_cell_index</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]]</span>
            <span class="n">adata_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_cell_index</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]]</span>
            <span class="n">adata_context</span><span class="o">.</span><span class="n">obs_names_make_unique</span><span class="p">()</span> 
            <span class="n">adata_target</span><span class="o">.</span><span class="n">obs_names_make_unique</span><span class="p">()</span> 

            <span class="n">filtered_data_ind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_outliers</span><span class="p">(</span><span class="n">adata_context</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">],</span> <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">)</span>
            <span class="n">adata_context</span> <span class="o">=</span> <span class="n">adata_context</span><span class="p">[</span><span class="n">filtered_data_ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">filtered_data_ind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_outliers</span><span class="p">(</span><span class="n">adata_target</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">],</span> <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">)</span>
            <span class="n">adata_target</span> <span class="o">=</span> <span class="n">adata_target</span><span class="p">[</span><span class="n">filtered_data_ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    

            <span class="n">latent_target</span> <span class="o">=</span> <span class="n">adata_target</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">]</span>
            <span class="n">latent_context</span> <span class="o">=</span> <span class="n">adata_context</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">]</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">latent_context</span><span class="p">)</span>
            <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">latent_target</span><span class="p">)</span>
            <span class="n">adata_target</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;cell_context_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span>

            <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">adata_target</span><span class="o">.</span><span class="n">n_obs</span><span class="o">/</span><span class="n">b_s</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>    
            <span class="n">sampling_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">samples</span> <span class="o">/</span> <span class="n">adata_target</span><span class="o">.</span><span class="n">n_obs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">lfc_list</span> <span class="o">=</span> <span class="p">[]</span>    
                <span class="n">lfc_list_random</span> <span class="o">=</span> <span class="p">[]</span>                  
                <span class="n">rho_mouse</span> <span class="o">=</span> <span class="p">[]</span>     
                <span class="n">mu_mouse</span> <span class="o">=</span> <span class="p">[]</span>        
                <span class="n">rho_human</span> <span class="o">=</span> <span class="p">[]</span>     
                <span class="n">mu_human</span> <span class="o">=</span> <span class="p">[]</span>                    

                <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>   
                    <span class="n">batch_adata</span> <span class="o">=</span> <span class="n">adata_target</span><span class="p">[</span><span class="n">step</span><span class="o">*</span><span class="n">b_s</span><span class="p">:(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">b_s</span><span class="p">]</span>
                    <span class="n">context_cell_type</span> <span class="o">=</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">target_cell_type</span> <span class="o">=</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1">#np.array([&#39;unknown&#39;]*batch_adata.n_obs)</span>

                    <span class="n">context_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_type</span><span class="p">])</span>
                    <span class="n">target_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_type</span><span class="p">])</span>
                    <span class="n">context_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">context_labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                    <span class="n">target_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>            

                    <span class="n">context_ind_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_batches</span><span class="p">[</span><span class="n">c</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context_cell_type</span><span class="p">])</span>
                    <span class="n">target_ind_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">target_batches</span><span class="p">[</span><span class="n">c</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">target_cell_type</span><span class="p">])</span>

                    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_sig&#39;</span><span class="p">])</span>
                    
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sampling_size</span><span class="p">):</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_sig&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> 
                        <span class="n">target_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_mu&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_sig&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)))</span>
                        <span class="n">neigh_ind</span> <span class="o">=</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;cell_context_ind&#39;</span><span class="p">]</span>
                        
                        <span class="n">context_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">adata_context</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_mu&#39;</span><span class="p">][</span><span class="n">neigh_ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">adata_context</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_sig&#39;</span><span class="p">][</span><span class="n">neigh_ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                        <span class="n">context_l</span> <span class="o">=</span> <span class="n">context_l</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                        <span class="n">context_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context_ind_batch</span><span class="p">)])</span>
                        <span class="n">target_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_ind_batch</span><span class="p">)])</span>

                        <span class="n">context_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">context_z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                        <span class="n">target_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">target_z</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>

                        <span class="n">context_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">decode_homologous</span><span class="p">(</span><span class="n">context_z</span><span class="p">,</span> <span class="n">context_labels</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="n">context_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_slices</span><span class="p">(</span><span class="n">context_rho</span><span class="p">,</span> <span class="n">context_ind_batch</span><span class="p">)</span>

                        <span class="n">target_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">decode_homologous</span><span class="p">(</span><span class="n">target_z</span><span class="p">,</span> <span class="n">target_labels</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="n">target_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_slices</span><span class="p">(</span><span class="n">target_rho</span><span class="p">,</span> <span class="n">target_ind_batch</span><span class="p">)</span>
   
                        <span class="n">context_mu</span> <span class="o">=</span> <span class="n">context_rho</span> <span class="o">*</span> <span class="n">context_l</span>
                        <span class="n">target_mu</span> <span class="o">=</span> <span class="n">target_rho</span> <span class="o">*</span> <span class="n">target_l</span>

                        <span class="n">rho_mouse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_rho</span><span class="p">)</span>
                        <span class="n">mu_mouse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_mu</span><span class="p">)</span>
                        <span class="n">rho_human</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_rho</span><span class="p">)</span>
                        <span class="n">mu_human</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_mu</span><span class="p">)</span>

                        <span class="n">lfc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">target_rho</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">context_rho</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>
                        <span class="n">lfc_list_random</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">target_rho</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">context_rho</span><span class="p">[:,</span> <span class="n">random_perm</span><span class="p">]</span><span class="o">+</span><span class="n">eps</span><span class="p">))</span>

            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">target_gene_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;rho_median_context&#39;</span><span class="p">,</span> <span class="s1">&#39;mu_median_context&#39;</span><span class="p">,</span> <span class="s1">&#39;rho_median_target&#39;</span><span class="p">,</span> <span class="s1">&#39;mu_median_target&#39;</span><span class="p">,</span> <span class="s1">&#39;lfc&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;lfc_rand&#39;</span><span class="p">,</span> <span class="s1">&#39;p_rand&#39;</span><span class="p">])</span>

            <span class="n">rho_mouse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">rho_mouse</span><span class="p">)</span>
            <span class="n">mu_mouse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mu_mouse</span><span class="p">)</span>
            <span class="n">rho_human</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">rho_human</span><span class="p">)</span>
            <span class="n">mu_human</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mu_human</span><span class="p">)</span>

            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;rho_median_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">rho_mouse</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;mu_median_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mu_mouse</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;rho_median_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">rho_human</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;mu_median_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mu_human</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>        

            <span class="n">lfc_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">lfc_list</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;lfc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lfc_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lfc_list</span><span class="p">)</span><span class="o">&gt;</span><span class="n">lfc_delta</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lfc_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">lfc_list_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">lfc_list_random</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;lfc_rand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lfc_list_random</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lfc_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">][</span><span class="s1">&#39;p_rand&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lfc_list_random</span><span class="p">)</span><span class="o">&gt;</span><span class="n">lfc_delta</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lfc_list_random</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">lfc_dict</span><span class="p">[</span><span class="s1">&#39;lfc_delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lfc_delta</span>
        <span class="k">return</span> <span class="n">lfc_dict</span></div>



<div class="viewcode-block" id="scSpecies.mode_histogram">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.mode_histogram">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mode_histogram</span><span class="p">(</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> 
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>      
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the mid-point of the histogram bin with the highest count.</span>
<span class="sd">        Helper for .self.similarity_cell_types</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------   </span>
<span class="sd">        x : np.array,</span>
<span class="sd">            Array of values for which to calculate the modal value.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mode: np.float32 </span>
<span class="sd">            modal value of the empirical distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">counts</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;fd&#39;</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>                 
        <span class="k">return</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span></div>


<div class="viewcode-block" id="scSpecies.return_similarity_df">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.return_similarity_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_similarity_df</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">max_sample_targ</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
            <span class="n">max_sample_cont</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and return similarity scores between target and context cell types</span>
<span class="sd">        by sampling from latent cell type ditributions and calculating likelihood differences.</span>
<span class="sd">        Computes the modal value of the resulting distribution as similarity score.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_sample_targ : int, default=2000</span>
<span class="sd">            Number of samples from the target cell types.</span>
<span class="sd">        max_sample_cont : int, default=50</span>
<span class="sd">            Number of samples from the context cell types per target cell.</span>
<span class="sd">        scale : {&#39;min_max&#39;, &#39;max&#39;, &#39;none&#39;}, default=&#39;max&#39;</span>
<span class="sd">            Scaling strategy across rows: min-max normalization or max-based inversion.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            Similarity scores with</span>
<span class="sd">            - index: target cell types,</span>
<span class="sd">            - columns: context cell types.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">context_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]</span>
        <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]</span>

        <span class="n">cell_key_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>
        <span class="n">cell_key_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>

        <span class="n">cells_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_key_context</span><span class="p">]</span>
        <span class="n">cells_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_key_target</span><span class="p">]</span>

        <span class="n">cell_types_context</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cells_context</span><span class="p">)</span>
        <span class="n">cell_types_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cells_target</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">cell_types_target</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cell_types_context</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_types_target</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_types_context</span><span class="p">)):</span>

                <span class="n">target_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cells_target</span> <span class="o">==</span> <span class="n">cell_types_target</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">target_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">target_ind</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">max_sample_targ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">target_ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  

                <span class="n">context_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cells_context</span> <span class="o">==</span> <span class="n">cell_types_context</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">context_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">context_ind</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">max_sample_cont</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">context_ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">target_ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">])])</span>

                <span class="n">sim_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_metric</span><span class="p">(</span><span class="n">target_ind</span><span class="p">,</span> <span class="n">context_ind</span><span class="p">,</span> <span class="n">b_s</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">b_sc</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">sim_metric_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_histogram</span><span class="p">(</span><span class="n">sim_metric</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_types_target</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cell_types_context</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sim_metric_mode</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;min_max&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>    
            <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>    
            <span class="n">df</span> <span class="o">=</span> <span class="o">-</span> <span class="n">df</span>

        <span class="k">return</span>  <span class="n">df</span></div>



<div class="viewcode-block" id="scSpecies.update_param">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.update_param">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_param</span><span class="p">(</span>    
            <span class="n">parameter</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">min_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">max_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Linearly increment `parameter` toward `max_value` over `steps`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter : float</span>
<span class="sd">            Current parameter value.</span>
<span class="sd">        min_value : float</span>
<span class="sd">            Starting value.</span>
<span class="sd">        max_value : float</span>
<span class="sd">            Final cap.</span>
<span class="sd">        steps : int</span>
<span class="sd">            Number of increments until max.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Updated (and capped) parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">min_value</span> <span class="o">==</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parameter</span>

        <span class="n">parameter</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_value</span> <span class="o">-</span> <span class="n">min_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span></div>



<div class="viewcode-block" id="scSpecies.train_context">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.train_context">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_context</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
            <span class="n">raise_beta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">train_decoder_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pretrain the context scVI model on the context dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epochs : int, default=40</span>
<span class="sd">            Number of training epochs.</span>
<span class="sd">        raise_beta : bool, default=True</span>
<span class="sd">            If True, increase KL weight over initial epochs.</span>
<span class="sd">        save_model : bool, default=True</span>
<span class="sd">            If True, save model parameters after training.</span>
<span class="sd">        train_decoder_only : bool, default=False</span>
<span class="sd">            If True, freeze encoders and train only the decoder.</span>
<span class="sd">        save_key : str, default=&#39;&#39;</span>
<span class="sd">            Filename suffix when saving.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">b_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span>

        <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_obs</span><span class="o">/</span><span class="n">b_s</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
            <span class="n">progBar</span> <span class="o">=</span> <span class="n">Progress_Bar</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nELBO&#39;</span><span class="p">,</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">,</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">,</span> <span class="s1">&#39;KL-Div l&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>     
            <span class="n">progBar</span> <span class="o">=</span> <span class="n">Progress_Bar</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nELBO&#39;</span><span class="p">,</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">,</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pretraining on the context dataset for </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s1"> epochs (= </span><span class="si">{</span><span class="n">epochs</span><span class="o">*</span><span class="n">steps_per_epoch</span><span class="si">}</span><span class="s1"> iterations).&#39;</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;batch_label_enc&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
            <span class="n">lib_mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;library_log_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="n">lib_sig</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;library_log_std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">train_decoder_only</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
     
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="n">perm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)</span>  

            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_per_epoch</span><span class="p">):</span>         
                <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">x_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="n">perm</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">b_s</span><span class="p">)</span>
                <span class="n">s_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="n">perm</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">b_s</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="n">lib_mu_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">lib_mu</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="n">perm</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">b_s</span><span class="p">)</span>
                    <span class="n">lib_sig_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">lib_sig</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="n">perm</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">b_s</span><span class="p">)</span>

                <span class="n">z_batch</span><span class="p">,</span> <span class="n">z_kl_div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">))</span> 
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="n">l_batch</span><span class="p">,</span> <span class="n">l_kl_div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">lib_mu_batch</span><span class="p">,</span> <span class="n">lib_sig_batch</span><span class="p">)</span>     
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">l_batch</span> <span class="o">=</span> <span class="n">x_batch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="n">nlog_likeli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="p">(</span><span class="n">z_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">l_batch</span><span class="p">,</span> <span class="n">x_batch</span><span class="p">)</span>
                <span class="n">nelbo</span> <span class="o">=</span> <span class="n">nlog_likeli</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_kl_div</span> 
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="n">nelbo</span> <span class="o">=</span> <span class="n">nelbo</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l_kl_div</span>

                <span class="n">nelbo</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">context_likeli_hist_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nlog_likeli</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="n">progBar</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nELBO&#39;</span><span class="p">:</span> <span class="n">nelbo</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">:</span> <span class="n">nlog_likeli</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_kl_div</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;KL-Div l&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l_kl_div</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()})</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">progBar</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nELBO&#39;</span><span class="p">:</span> <span class="n">nelbo</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">:</span> <span class="n">nlog_likeli</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_kl_div</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()})</span>

            <span class="k">if</span> <span class="n">raise_beta</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta_start&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta_max&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;beta_epochs_raise&#39;</span><span class="p">])</span>    


        <span class="k">if</span> <span class="ow">not</span> <span class="n">train_decoder_only</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_model</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>    
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span><span class="n">save_key</span><span class="o">=</span><span class="n">save_key</span><span class="p">)</span>  </div>


<div class="viewcode-block" id="scSpecies.train_target">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.train_target">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
            <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">raise_beta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">raise_eta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">save_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the target-side scVI model, optionally aligning to context.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epochs : int, default=40</span>
<span class="sd">            Number of training epochs.</span>
<span class="sd">        save_model : bool, default=True</span>
<span class="sd">            Save parameters after training.</span>
<span class="sd">        raise_beta : bool, default=True</span>
<span class="sd">            If True, increase KL weight over initial epochs.</span>
<span class="sd">        raise_eta : bool, default=True</span>
<span class="sd">            If True, increase alignment weight over initial epochs.</span>
<span class="sd">        save_key : str, default=&#39;&#39;</span>
<span class="sd">            Suffix for saved files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_cell_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;cell_key&#39;</span><span class="p">]</span>

        <span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">n_obs</span>
        <span class="n">k_neigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;k_neigh&#39;</span><span class="p">]</span>
        <span class="n">top_percent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;top_percent&#39;</span><span class="p">]</span>

        <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_obs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
            <span class="n">progBar</span> <span class="o">=</span> <span class="n">Progress_Bar</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nELBO&#39;</span><span class="p">,</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">,</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">,</span> <span class="s1">&#39;KL-Div l&#39;</span><span class="p">,</span> <span class="s1">&#39;Align-Term&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>     
            <span class="n">progBar</span> <span class="o">=</span> <span class="n">Progress_Bar</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nELBO&#39;</span><span class="p">,</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">,</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">,</span> <span class="s1">&#39;Align-Term&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training on the target dataset for </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s1"> epochs (= </span><span class="si">{</span><span class="n">epochs</span><span class="o">*</span><span class="n">steps_per_epoch</span><span class="si">}</span><span class="s1"> iterations).&#39;</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="n">perm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)</span>     

            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_per_epoch</span><span class="p">):</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">target_optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">batch_adata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]][</span><span class="n">perm</span><span class="p">[</span><span class="n">step</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]:(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]]]</span>

                <span class="n">x_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="n">perm</span><span class="p">)</span>
                <span class="n">s_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;batch_label_enc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>      
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>   
                    <span class="n">lib_mu_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;library_log_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>          
                    <span class="n">lib_sig_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;library_log_std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  

                <span class="n">inter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">)</span>

                <span class="n">z_batch</span><span class="p">,</span> <span class="n">z_kl_div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>      
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>           
                    <span class="n">l_batch</span><span class="p">,</span> <span class="n">l_kl_div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">lib_mu_batch</span><span class="p">,</span> <span class="n">lib_sig_batch</span><span class="p">)</span>   
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">l_batch</span> <span class="o">=</span> <span class="n">x_batch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        
                <span class="n">nlog_likeli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="p">(</span><span class="n">z_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">l_batch</span><span class="p">,</span> <span class="n">x_batch</span><span class="p">)</span>                    
                <span class="n">ind_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;top_percent_&#39;</span><span class="o">+</span><span class="n">target_cell_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">&lt;</span><span class="n">top_percent</span><span class="o">/</span><span class="mi">100</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ind_top</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ind_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

                <span class="n">ind_neigh</span> <span class="o">=</span> <span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;ind_neigh_nns&#39;</span><span class="p">][</span><span class="n">ind_top</span><span class="p">,</span> <span class="p">:</span><span class="n">k_neigh</span><span class="p">]</span>
                <span class="n">neigh_mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">][</span><span class="n">ind_neigh</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>  
                <span class="n">neigh_sig</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_sig&#39;</span><span class="p">][</span><span class="n">ind_neigh</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>    
                <span class="n">neigh_z</span> <span class="o">=</span> <span class="n">neigh_mu</span> <span class="o">+</span> <span class="n">neigh_sig</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">sampling_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">neigh_sig</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">neigh_sig</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)]))</span>
                  
                <span class="n">s_interl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">s_batch</span><span class="p">[</span><span class="n">ind_top</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">k_neigh</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">l_interl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">l_batch</span><span class="p">[</span><span class="n">ind_top</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">k_neigh</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x_interl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">x_batch</span><span class="p">[</span><span class="n">ind_top</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">k_neigh</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">neigh_z</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">neigh_z</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">s_interl</span><span class="p">)</span>

                <span class="n">nlog_likeli_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">calc_nlog_likelihood</span><span class="p">(</span><span class="n">outp</span><span class="p">,</span> <span class="n">l_interl</span><span class="p">,</span> <span class="n">x_interl</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ind_top</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_neigh</span><span class="p">)</span>
                <span class="n">best_pin_for_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">nlog_likeli_neighbors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inter&#39;</span><span class="p">:</span>
                    <span class="n">align_target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;inter&#39;</span><span class="p">][</span><span class="n">batch_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;ind_neigh_nns&#39;</span><span class="p">][</span><span class="n">ind_top</span><span class="p">,</span> <span class="n">best_pin_for_x</span><span class="p">]])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
                    <span class="n">sqerror_align</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">inter</span><span class="p">[</span><span class="n">ind_top</span><span class="p">]</span> <span class="o">-</span> <span class="n">align_target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;latent&#39;</span><span class="p">:</span>
                    <span class="n">sqerror_align</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">z_batch</span><span class="p">[</span><span class="n">ind_top</span><span class="p">]</span> <span class="o">-</span> <span class="n">neigh_z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_top</span><span class="p">)),</span> <span class="n">best_pin_for_x</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="n">nelbo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_kl_div</span> <span class="o">+</span> <span class="n">nlog_likeli</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sqerror_align</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="n">nelbo</span> <span class="o">=</span> <span class="n">nelbo</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l_kl_div</span>

                <span class="n">nelbo</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">target_likeli_hist_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nlog_likeli</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                    <span class="n">progBar</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nELBO&#39;</span><span class="p">:</span> <span class="n">nelbo</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">:</span> <span class="n">nlog_likeli</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_kl_div</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;KL-Div l&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l_kl_div</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;Align-Term&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sqerror_align</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()})</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">progBar</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nELBO&#39;</span><span class="p">:</span> <span class="n">nelbo</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;nlog_likeli&#39;</span><span class="p">:</span> <span class="n">nlog_likeli</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;KL-Div z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_kl_div</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;Align-Term&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sqerror_align</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()})</span>

            <span class="k">if</span> <span class="n">raise_beta</span><span class="p">:</span>       
                <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta_start&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta_max&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;beta_epochs_raise&#39;</span><span class="p">])</span>    
            <span class="k">if</span> <span class="n">raise_eta</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta_start&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta_max&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;eta_epochs_raise&#39;</span><span class="p">])</span>    


        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">target_decoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_model</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span><span class="n">save_key</span><span class="o">=</span><span class="n">save_key</span><span class="p">)</span>        </div>



<div class="viewcode-block" id="scSpecies.encode">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.encode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span>    
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">s</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">encoder_outer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">encoder_inner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">lib_encoder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode data into biological and/or library latent variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : Tensor, shape (n_cells, n_genes)</span>
<span class="sd">            Raw or log-transformed count matrix.</span>
<span class="sd">        s : Tensor, shape (n_cells, n_batches)</span>
<span class="sd">            One-hot encoded batch labels.</span>
<span class="sd">        encoder_outer : nn.Module, optional</span>
<span class="sd">            Outer encoder; if None, skips z/inter outputs.</span>
<span class="sd">        encoder_inner : nn.Module, optional</span>
<span class="sd">            Inner encoder; if None, skips z/inter outputs.</span>
<span class="sd">        lib_encoder : nn.Module, optional</span>
<span class="sd">            Library encoder; if None, skips l_mu/l_sig outputs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Depending on provided encoders:</span>
<span class="sd">        (z_mu, z_sig, inter) if `lib_encoder` is None.</span>
<span class="sd">        (l_mu, l_sig) if only `lib_encoder` is provided.</span>
<span class="sd">        (z_mu, z_sig, inter, l_mu, l_sig) if all provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;b_s&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">))</span>        

        <span class="k">if</span> <span class="n">encoder_outer</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">encoder_inner</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encoder_outer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">encoder_inner</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">z_mu_list</span><span class="p">,</span> <span class="n">z_sig_list</span><span class="p">,</span> <span class="n">inter_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">lib_encoder</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lib_encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">l_mu_list</span><span class="p">,</span> <span class="n">l_sig_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>    
        
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>   
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Calculate latent variables. Step </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

                <span class="n">x_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">s_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">encoder_outer</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">encoder_inner</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">inter</span> <span class="o">=</span> <span class="n">encoder_outer</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">)</span> 
                    <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_log_sig</span> <span class="o">=</span> <span class="n">encoder_inner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>             

                    <span class="n">z_mu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_mu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="n">z_sig_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_log_sig</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>                    
                    <span class="n">inter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inter</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">lib_encoder</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;use_lib_enc&#39;</span><span class="p">]:</span>
                        <span class="n">l_mu</span><span class="p">,</span> <span class="n">l_log_sig</span> <span class="o">=</span> <span class="n">lib_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">)</span>  
                    <span class="k">else</span><span class="p">:</span>         
                        <span class="n">l_mu</span><span class="p">,</span> <span class="n">l_log_sig</span> <span class="o">=</span> <span class="n">x_batch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_batch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
          
                    <span class="n">l_mu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_mu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="n">l_sig_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_log_sig</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>                        

            <span class="k">if</span> <span class="n">encoder_outer</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">encoder_inner</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lib_encoder</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">z_mu_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">z_sig_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">inter_list</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">encoder_outer</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">encoder_inner</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lib_encoder</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">l_mu_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">l_mu_list</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">encoder_outer</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">encoder_inner</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lib_encoder</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">z_mu_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">z_sig_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">inter_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">l_mu_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">l_sig_list</span><span class="p">)</span>          </div>


<div class="viewcode-block" id="scSpecies.get_representation">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.scSpecies.get_representation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_representation</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">eval_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">save_intermediate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">save_libsize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">):</span> 

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and store biological latent and/or library latent representations for a dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eval_model : {&#39;context&#39;,&#39;target&#39;}</span>
<span class="sd">            Which dataset to encode.</span>
<span class="sd">        save_intermediate : bool, default=False</span>
<span class="sd">            If True, store the outer encoder output in `.obsm[&#39;inter&#39;]`.</span>
<span class="sd">        save_libsize : bool, default=False</span>
<span class="sd">            If True, store library mean/log-std in `.obsm[&#39;l_mu&#39;]`/`[&#39;l_sig&#39;]`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">eval_model</span> <span class="o">==</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span>
            <span class="n">dataset_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;target_key&#39;</span><span class="p">]</span>
            <span class="n">encoder_outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_outer</span>
            <span class="n">encoder_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_encoder_inner</span>
            <span class="n">lib_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_lib_encoder</span>

        <span class="k">elif</span> <span class="n">eval_model</span> <span class="o">==</span> <span class="s1">&#39;context&#39;</span><span class="p">:</span>
            <span class="n">dataset_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;context_key&#39;</span><span class="p">]</span>
            <span class="n">encoder_outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_outer</span>
            <span class="n">encoder_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_encoder_inner</span>
            <span class="n">lib_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_lib_encoder</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;batch_label_enc&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">save_libsize</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inter&#39;</span><span class="p">:</span>
                <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_sig</span><span class="p">,</span> <span class="n">inter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">encoder_outer</span><span class="o">=</span><span class="n">encoder_outer</span><span class="p">,</span> <span class="n">encoder_inner</span><span class="o">=</span><span class="n">encoder_inner</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;latent&#39;</span><span class="p">:</span>
                <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_sig</span><span class="p">,</span> <span class="n">inter</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">encoder_outer</span><span class="o">=</span><span class="n">encoder_outer</span><span class="p">,</span> <span class="n">encoder_inner</span><span class="o">=</span><span class="n">encoder_inner</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">save_libsize</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inter&#39;</span><span class="p">:</span>
                <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_sig</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">l_mu</span><span class="p">,</span> <span class="n">l_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">encoder_outer</span><span class="o">=</span><span class="n">encoder_outer</span><span class="p">,</span> <span class="n">encoder_inner</span><span class="o">=</span><span class="n">encoder_inner</span><span class="p">,</span> <span class="n">lib_encoder</span><span class="o">=</span><span class="n">lib_encoder</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;latent&#39;</span><span class="p">:</span>
                <span class="n">z_mu</span><span class="p">,</span> <span class="n">z_sig</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">l_mu</span><span class="p">,</span> <span class="n">l_sig</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">encoder_outer</span><span class="o">=</span><span class="n">encoder_outer</span><span class="p">,</span> <span class="n">encoder_inner</span><span class="o">=</span><span class="n">encoder_inner</span><span class="p">,</span> <span class="n">lib_encoder</span><span class="o">=</span><span class="n">lib_encoder</span><span class="p">)</span>  

        <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;z_sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_sig</span>
           
        <span class="k">if</span> <span class="n">save_intermediate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;inter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inter</span>

        <span class="k">if</span> <span class="n">save_libsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_mu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;l_sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_sig</span></div>
</div>



<div class="viewcode-block" id="color_str">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.color_str">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">color_str</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[38;5;208m</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[38;5;135m</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span></div>



<div class="viewcode-block" id="Progress_Bar">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Progress_Bar">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Progress_Bar</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A console progress bar that tracks multiple metrics over training iterations of scSpecies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    epochs : int</span>
<span class="sd">        Total number of epochs.</span>
<span class="sd">    steps_per_epoch : int</span>
<span class="sd">        Number of steps (batches) in each epoch.</span>
<span class="sd">    metrics : list of str</span>
<span class="sd">        Names of metrics to track (e.g., [&#39;nELBO&#39;, &#39;nlog_likeli&#39;]).</span>
<span class="sd">    avg_over_n_steps : int, optional</span>
<span class="sd">        Number of recent steps over which to average metric values for display.</span>
<span class="sd">    sleep_print : float, optional</span>
<span class="sd">        Interval in seconds between console updates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Progress_Bar.__init__">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Progress_Bar.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">steps_per_epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
            <span class="n">avg_over_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
            <span class="n">sleep_print</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">steps_per_epoch</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">*</span> <span class="n">steps_per_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">*</span> <span class="n">steps_per_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_over_n_steps</span> <span class="o">=</span> <span class="n">avg_over_n_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_print</span> <span class="o">=</span> <span class="n">sleep_print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Progress&#39;</span><span class="p">,</span> <span class="s1">&#39;ETA&#39;</span><span class="p">,</span> <span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="s1">&#39;ms/Iteration&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;Progress&#39;</span> <span class="p">:</span> <span class="s2">&quot;0.000%&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;ETA&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s1">&#39;Epoch&#39;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                    <span class="s1">&#39;Iteration&#39;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;ms/Iteration&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()]</span>
                    <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">metric</span><span class="o">+</span><span class="s1">&#39; last ep&#39;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">metric</span><span class="o">+</span><span class="s1">&#39; impr&#39;</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">})</span></div>

        
<div class="viewcode-block" id="Progress_Bar.format_number">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Progress_Bar.format_number">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_number</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">min_length</span><span class="p">):</span>
        <span class="n">decimal_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>  
        <span class="n">decimal_places</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_length</span> <span class="o">-</span> <span class="n">decimal_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 

        <span class="n">formatted_number</span> <span class="o">=</span> <span class="s2">&quot;{:.</span><span class="si">{}</span><span class="s2">f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">decimal_places</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">formatted_number</span></div>

    
<div class="viewcode-block" id="Progress_Bar.ret_sign">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Progress_Bar.ret_sign">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ret_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">min_length</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m</span><span class="si">{}</span><span class="se">\033</span><span class="s1">[00m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">min_length</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m</span><span class="si">{}</span><span class="se">\033</span><span class="s1">[00m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">min_length</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sign_str</span> <span class="o">=</span> <span class="s1">&#39;---&#39;</span>
        <span class="k">return</span>  <span class="n">sign_str</span>      </div>


<div class="viewcode-block" id="Progress_Bar.update">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.Progress_Bar.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_steps</span> <span class="o">-=</span> <span class="mi">1</span>   
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> 
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Iteration&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39; last ep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> 
             
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Iteration&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Iteration&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">epoch</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39; last ep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">:]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39; impr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39; last ep&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39; last ep&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch</span>
     
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
  
        <span class="n">avg_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Iteration&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_over_n_steps</span><span class="p">))</span>
        <span class="n">avg_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="o">-</span><span class="n">avg_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">avg_steps</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;ETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remaining_steps</span> <span class="o">*</span> <span class="n">avg_time</span><span class="p">))</span>         
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;ms/Iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">avg_time</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Progress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;Iteration&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%&#39;</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tic</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep_print</span><span class="p">:</span>
            <span class="n">metric_string</span> <span class="o">=</span>  <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[95m</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\033</span><span class="s1">[00m: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_metrics</span><span class="p">]</span>       
            <span class="n">metric_string</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[33m</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\033</span><span class="s1">[00m: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">-</span><span class="n">avg_steps</span><span class="p">:]),</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ret_sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot; impr&quot;</span><span class="p">],</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">]</span>               
            <span class="n">metric_string</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[96m - </span><span class="se">\033</span><span class="s2">[00m&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric_string</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">metric_string</span><span class="si">}</span><span class="s2">.           &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
            <span class="bp">self</span><span class="o">.</span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>   </div>
</div>




<div class="viewcode-block" id="neighbors_workaround">
<a class="viewcode-back" href="../../scspecies.html#scspecies.models.neighbors_workaround">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">neighbors_workaround</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
        <span class="n">use_rep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the k-nearest-neighbors graph manually and store it in `adata`.</span>
<span class="sd">    Replacement for sc.pp.neighbors on M1/M2 chips to avoid kernel crashes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : ad.AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    use_rep : str</span>
<span class="sd">        Key in `adata.obsm` to use for neighbor search (e.g. &#39;X_pca&#39;),</span>
<span class="sd">        or None to use `adata.X`.</span>
<span class="sd">    n_neighbors : int</span>
<span class="sd">        Number of nearest neighbors to use.</span>
<span class="sd">    metric : str or None</span>
<span class="sd">        Distance metric to use (default &#39;euclidean&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    AnnData</span>
<span class="sd">        The same `adata`, with:</span>
<span class="sd">          - obsp[&#39;distances&#39;]       : sparse matrix of neighbor distances</span>
<span class="sd">          - obsp[&#39;connectivities&#39;]  : sparse binary connectivity matrix</span>
<span class="sd">          - uns[&#39;neighbors&#39;]        : dict of params &amp; key names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">use_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
        <span class="n">rep_key</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">use_rep</span><span class="p">]</span>
        <span class="n">rep_key</span> <span class="o">=</span> <span class="n">use_rep</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s2">&quot;toarray&quot;</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">n_obs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">nbrs</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nbrs</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_obs</span><span class="p">),</span> <span class="n">n_neighbors</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">data_dist</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data_dist</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">))</span>

    <span class="n">data_conn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">data_dist</span><span class="p">)</span>
    <span class="n">conn_matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data_conn</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">))</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_matrix</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s1">&#39;connectivities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_matrix</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;n_neighbors&#39;</span><span class="p">:</span> <span class="n">n_neighbors</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;umap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;use_rep&#39;</span><span class="p">:</span> <span class="n">rep_key</span><span class="p">,</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span>
        <span class="p">},</span>
        <span class="s1">&#39;distances_key&#39;</span><span class="p">:</span> <span class="s1">&#39;distances&#39;</span><span class="p">,</span>
        <span class="s1">&#39;connectivities_key&#39;</span><span class="p">:</span> <span class="s1">&#39;connectivities&#39;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">adata</span>            </div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Clemens Schächter.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>