

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scspecies.plot &mdash; scspecies Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css?v=572af1d6" />
      <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            scspecies
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Navigation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips to fit scSpecies</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">scspecies</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scspecies.plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scspecies.plot</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">glasbey</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">ticker</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">muon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mu</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">spearmanr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">kendalltau</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>


<div class="viewcode-block" id="progressive_moving_average">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.progressive_moving_average">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">progressive_moving_average</span><span class="p">(</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">max_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a moving average over a 1D array with a window</span>
<span class="sd">    that grows linearly (capped by max_window) to smooth early iterations </span>
<span class="sd">    more strongly and later ones less.</span>
<span class="sd">    Helper for `plot_prototype_sim_history`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : np.ndarray</span>
<span class="sd">        Input 1D array of values (e.g., losses or metrics over iterations).</span>
<span class="sd">    max_window : int, default=6000</span>
<span class="sd">        Maximum size of the moving window.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Smoothed values of the same shape as `y`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">max_window</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">])</span></div>



<div class="viewcode-block" id="plot_lfc">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.plot_lfc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_lfc</span><span class="p">(</span>
        <span class="n">lfc_dict</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>    
        <span class="n">prob_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">save_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>         
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scatter-plot Log2-Fold-change versus probability for each cell type,</span>
<span class="sd">    highlighting and annotating top up- and down-regulated genes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lfc_dict : list</span>
<span class="sd">        List of LFC dataframes.</span>
<span class="sd">    prob_delta : float, default=0.9</span>
<span class="sd">        Probability threshold for calling significant LFC.</span>
<span class="sd">    save_key : str or None, default=None</span>
<span class="sd">        If a string, the plot will be saved to `figures/{save_key}.png`. If None, it will only be displayed.   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cell_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lfc_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;lfc_delta&#39;</span><span class="p">])</span>
    <span class="n">df_lfc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">lfc_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">][</span><span class="s1">&#39;lfc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">})</span>
    <span class="n">df_prob</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">lfc_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">})</span>
    <span class="n">lfc_delta</span> <span class="o">=</span> <span class="n">lfc_dict</span><span class="p">[</span><span class="s1">&#39;lfc_delta&#39;</span><span class="p">]</span>
    <span class="n">cell_types</span> <span class="o">=</span> <span class="n">df_prob</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">n_cell_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>  
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_cell_types</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">n_cols</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_rows</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">ge_one</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ge_prob</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">up_reg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">down_reg</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_types</span><span class="p">):</span>
        <span class="n">greater_than_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(((</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">lfc_delta</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">greater_than_one_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(((</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span><span class="n">lfc_delta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">prob_delta</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(((</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lfc_delta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">prob_delta</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(((</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">lfc_delta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">prob_delta</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">ge_one</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">greater_than_one</span><span class="p">)</span>
        <span class="n">ge_prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">greater_than_one_prob</span><span class="p">)</span>
        <span class="n">up_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up</span><span class="p">)</span>
        <span class="n">down_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">down</span><span class="p">)</span>
        
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span> <span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">prob_delta</span> <span class="k">else</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">prob_delta</span> <span class="k">else</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span> <span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Log Fold Change&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cell</span><span class="si">}</span><span class="s2"> |LFC|&gt;1, with p&gt;0.9: </span><span class="si">{</span><span class="n">greater_than_one_prob</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">prob_delta</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>

        <span class="n">up_subset</span> <span class="o">=</span> <span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">][(</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lfc_delta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">prob_delta</span><span class="p">)]</span>
        <span class="n">down_subset</span> <span class="o">=</span> <span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">][(</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">lfc_delta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_prob</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">prob_delta</span><span class="p">)]</span>
        
        <span class="n">top_up</span> <span class="o">=</span> <span class="n">up_subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">top_down</span> <span class="o">=</span> <span class="n">down_subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">up_text</span> <span class="o">=</span> <span class="s2">&quot;Upregulated:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">gene</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_up</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>
        <span class="n">down_text</span> <span class="o">=</span> <span class="s2">&quot;Downregulated:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">gene</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_down</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">,</span> <span class="n">up_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">,</span> <span class="n">down_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Differential gene expression analysis on the normalized decoder parameter space</span><span class="se">\n</span><span class="s1">&#39;</span> 
                <span class="sa">f</span><span class="s1">&#39;Median |LFC|&gt;1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ge_one</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">%, with p&gt;0.9: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ge_prob</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">. Up regulated: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">up_reg</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">%, down regulated: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">down_reg</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">%.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_key</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_prototype_sim_heatmap">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.plot_prototype_sim_heatmap">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_prototype_sim_heatmap</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">save_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>         
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Heatmap of prototype-similarity between target (rows) and context (columns)</span>
<span class="sd">    cell types, with top-2 matches annotated by rank.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Similarity matrix (target cell types × context cell types).</span>
<span class="sd">    save_key : str or None, default=None</span>
<span class="sd">        If a string, the plot will be saved to `figures/{save_key}.png`. If None, it will only be displayed.   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cell_types_context</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">cell_types_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">cell_types_context_reordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_types_context</span><span class="p">,</span> <span class="n">cell_types_target</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">cell_types_context</span><span class="p">,</span> <span class="n">cell_types_target</span><span class="p">)))</span>
    <span class="n">cell_types_target_reordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_types_context</span><span class="p">,</span> <span class="n">cell_types_target</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">cell_types_target</span><span class="p">,</span> <span class="n">cell_types_context</span><span class="p">)))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_types_target_reordered</span><span class="p">,</span> <span class="n">cell_types_context_reordered</span><span class="p">]</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">lower</span><span class="o">=-</span><span class="mi">2000</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="n">cols_liver</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Central Vein ECs&#39;</span><span class="p">,</span> <span class="s1">&#39;LSECs&#39;</span><span class="p">,</span> <span class="s1">&#39;Portal Vein ECs&#39;</span><span class="p">,</span> <span class="s1">&#39;Lymphatic ECs&#39;</span><span class="p">,</span> <span class="s1">&#39;Cholangiocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Hepatocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Mesothelial Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Capsule Fibroblasts&#39;</span><span class="p">,</span> <span class="s1">&#39;Fibroblast 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Fibroblast 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Stellate Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;B Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 Eff. Memory T&#39;</span><span class="p">,</span> <span class="s1">&#39;Cytotoxic CD8+&#39;</span><span class="p">,</span> <span class="s1">&#39;Naive CD8+ T&#39;</span><span class="p">,</span> <span class="s1">&#39;ILCs&#39;</span><span class="p">,</span> <span class="s1">&#39;NK Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;NKT Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Naive CD4+ T&#39;</span><span class="p">,</span> <span class="s1">&#39;Regulatory T&#39;</span><span class="p">,</span> <span class="s1">&#39;Th 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Th 17&#39;</span><span class="p">,</span> <span class="s1">&#39;Mig. DCs&#39;</span><span class="p">,</span> <span class="s1">&#39;cDCs 1&#39;</span><span class="p">,</span> <span class="s1">&#39;cDCs 2&#39;</span><span class="p">,</span> <span class="s1">&#39;pDCs&#39;</span><span class="p">,</span> <span class="s1">&#39;Basophils&#39;</span><span class="p">,</span> <span class="s1">&#39;Neutrophils&#39;</span><span class="p">,</span>  <span class="s1">&#39;MoMac1&#39;</span><span class="p">,</span> <span class="s1">&#39;MoMac2&#39;</span><span class="p">,</span> <span class="s1">&#39;Peritoneal Macs&#39;</span><span class="p">,</span> <span class="s1">&#39;KCs&#39;</span><span class="p">,</span> <span class="s1">&#39;Monocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Pat. Monocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Trans. Monocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Trans. Monocytes 2&#39;</span><span class="p">]</span>
    <span class="n">index_liver</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Central Vein ECs&#39;</span><span class="p">,</span> <span class="s1">&#39;LSECs&#39;</span><span class="p">,</span> <span class="s1">&#39;Portal Vein ECs&#39;</span><span class="p">,</span> <span class="s1">&#39;Cholangiocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Hepatocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Fibroblasts&#39;</span><span class="p">,</span> <span class="s1">&#39;Stellate Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Plasma&#39;</span><span class="p">,</span> <span class="s1">&#39;B Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Circ. Eff. Memory T&#39;</span><span class="p">,</span> <span class="s1">&#39;Cytotoxic CD8+&#39;</span><span class="p">,</span> <span class="s1">&#39;RM CD8+ T cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Circ. NK&#39;</span><span class="p">,</span> <span class="s1">&#39;NKT Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Tissue Resident NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Gamma-Delta T&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4+ KLRB1 Th&#39;</span><span class="p">,</span> <span class="s1">&#39;Naive/CM CD4+ T&#39;</span><span class="p">,</span> <span class="s1">&#39;Regulatory T&#39;</span><span class="p">,</span> <span class="s1">&#39;Mig. DCs&#39;</span><span class="p">,</span> <span class="s1">&#39;cDCs 1&#39;</span><span class="p">,</span> <span class="s1">&#39;cDCs 2&#39;</span><span class="p">,</span> <span class="s1">&#39;pDCs&#39;</span><span class="p">,</span> <span class="s1">&#39;Basophils&#39;</span><span class="p">,</span> <span class="s1">&#39;Neutrophils&#39;</span><span class="p">,</span> <span class="s1">&#39;MoMac1&#39;</span><span class="p">,</span> <span class="s1">&#39;immLAMs&#39;</span><span class="p">,</span> <span class="s1">&#39;matLAMs&#39;</span><span class="p">,</span> <span class="s1">&#39;KCs&#39;</span><span class="p">,</span> <span class="s1">&#39;Monocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Pat. Monocytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Pre-moKCs and moKCs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">index_liver</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_liver</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index_liver</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_liver</span><span class="p">)</span>

    <span class="n">top_2_indices</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">col_positions</span> <span class="o">=</span> <span class="p">[[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_2_indices</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> 
                <span class="n">annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">cmap</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;terrain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reversed</span><span class="p">(),</span>
                <span class="n">yticklabels</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                <span class="n">xticklabels</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_positions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>  
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">orig_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.82</span><span class="p">,</span> <span class="o">-</span><span class="mf">22.37</span><span class="p">,</span> <span class="o">-</span><span class="mf">31.63</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.73</span><span class="p">])</span>
        <span class="n">sqrt_ticks</span> <span class="o">=</span> <span class="n">orig_ticks</span>
        <span class="n">orig_vals</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt_ticks</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">sqrt_ticks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">orig_vals</span><span class="p">])</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Similarity value&quot;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Target and context cell prototype similarity scores&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cell types (context)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cell types (target)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_key</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_similarity">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.plot_similarity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_similarity</span><span class="p">(</span>
        <span class="n">adata_concat</span><span class="p">:</span> <span class="n">mu</span><span class="o">.</span><span class="n">MuData</span><span class="p">,</span>
        <span class="n">df_neigbor</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">human_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">rep_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;X_umap&#39;</span><span class="p">,</span>
        <span class="n">plot_annot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_type_fine&#39;</span><span class="p">,</span>
        <span class="n">context_species</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span>
        <span class="n">target_species</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span>
        <span class="n">save_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>         
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scatter dataset representation of context vs. target in 2D (e.g., UMAP) colored by similarity to a specified target cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata_concat : MuData</span>
<span class="sd">        Combined MuData with `.obsm[rep_key]` for both species.</span>
<span class="sd">    df_neigbor : pd.DataFrame</span>
<span class="sd">        DataFrame with columns [&#39;index&#39;,&#39;similarity_score&#39;] for a single target cell.</span>
<span class="sd">    human_ind : int</span>
<span class="sd">        Index of the target cell in `adata_concat`.</span>
<span class="sd">    rep_key : str, default=&#39;X_umap&#39;</span>
<span class="sd">        Key in `.obsm` for 2D coordinates.</span>
<span class="sd">    plot_annot : str, default=&#39;cell_type_fine&#39;</span>
<span class="sd">        Observation key for labeling the target cell.</span>
<span class="sd">    context_species : str, default=&#39;mouse&#39;</span>
<span class="sd">    target_species : str, default=&#39;human&#39;</span>
<span class="sd">    save_key : str or None, default=None</span>
<span class="sd">        If a string, the plot will be saved to `figures/{save_key}.png`. If None, it will only be displayed.   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">umap_context</span> <span class="o">=</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">rep_key</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">context_species</span><span class="p">]</span>
    <span class="n">umap_target</span> <span class="o">=</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">rep_key</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">target_species</span><span class="p">]</span>
    <span class="n">c_t</span> <span class="o">=</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">plot_annot</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">target_species</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">human_ind</span><span class="p">]</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="n">df_neigbor</span><span class="p">[</span><span class="s1">&#39;similarity_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">df_neigbor</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">umap_context</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">umap_target</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Representation must have exactly 2 dimensions (e.g., UMAP 2D coordinates)&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span> 

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_target</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40000</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">umap_target</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_context</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_context</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40000</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">umap_context</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">similarities</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn_r&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_target</span><span class="p">[</span><span class="n">human_ind</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[</span><span class="n">human_ind</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Similarity scores&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Similarity scores of </span><span class="si">{}</span><span class="s2"> cell (Index </span><span class="si">{}</span><span class="s2">) target cell with context cells.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_t</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">human_ind</span><span class="p">)))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_key</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_2D_representation">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.plot_2D_representation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_2D_representation</span><span class="p">(</span>
        <span class="n">adata_concat</span><span class="p">:</span> <span class="n">mu</span><span class="o">.</span><span class="n">MuData</span><span class="p">,</span>
        <span class="n">rep_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;X_umap&#39;</span><span class="p">,</span>
        <span class="n">plot_annot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell_type_fine&#39;</span><span class="p">,</span>
        <span class="n">context_species</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span>
        <span class="n">target_species</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span>
        <span class="n">save_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>         
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scatter dataset representation of context vs. target in 2D (e.g., UMAP) with shared color mapping based on labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata_concat : MuData</span>
<span class="sd">        Combined MuData with `.obsm[rep_key]` for both species.</span>
<span class="sd">    rep_key : str, default=&#39;X_umap&#39;</span>
<span class="sd">        Key in `.obsm` for 2D coordinates.</span>
<span class="sd">    plot_annot : str, default=&#39;cell_type_fine&#39;</span>
<span class="sd">        Observation key for the categorical annotation.</span>
<span class="sd">    context_species : str, default=&#39;mouse&#39;</span>
<span class="sd">    target_species : str, default=&#39;human&#39;</span>
<span class="sd">    save_key : str or None, default=None</span>
<span class="sd">        If a string, the plot will be saved to `figures/{save_key}.png`. If None, it will only be displayed.   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">umap_context</span> <span class="o">=</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">rep_key</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">context_species</span><span class="p">]</span>
    <span class="n">umap_target</span> <span class="o">=</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">rep_key</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">target_species</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">umap_context</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">umap_target</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Representation must have exactly 2 dimensions (e.g., UMAP 2D coordinates)&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax_A</span><span class="p">,</span> <span class="n">ax_B</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span> 

    <span class="n">col_dict</span> <span class="o">=</span> <span class="n">return_palette</span><span class="p">(</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">plot_annot</span><span class="p">])</span>

    <span class="n">colors_context</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">plot_annot</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">context_species</span><span class="p">]]</span>
    <span class="n">colors_target</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">plot_annot</span><span class="p">][</span><span class="n">adata_concat</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">target_species</span><span class="p">]]</span>

    <span class="n">perm_context</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_context</span><span class="p">))</span>
    <span class="n">perm_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_target</span><span class="p">))</span>

    <span class="n">ax_B</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_context</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_context</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40000</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_context</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
    <span class="n">ax_A</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_target</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40000</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_target</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>

    <span class="n">ax_A</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_context</span><span class="p">[</span><span class="n">perm_context</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_context</span><span class="p">[</span><span class="n">perm_context</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40000</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_context</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors_context</span><span class="p">)[</span><span class="n">perm_context</span><span class="p">])</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">umap_target</span><span class="p">[</span><span class="n">perm_target</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[</span><span class="n">perm_target</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40000</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_target</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors_target</span><span class="p">)[</span><span class="n">perm_target</span><span class="p">])</span>

    <span class="n">ax_B</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">)</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">)</span>

    <span class="n">ax_A</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">)</span>
    <span class="n">ax_A</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">umap_context</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">umap_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">*</span><span class="mf">1.04</span><span class="p">)</span>

    <span class="n">ax_A</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">context_species</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Representation (Context)&quot;</span><span class="p">)</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_species</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Representation (Target)&quot;</span><span class="p">)</span>

    <span class="n">ax_A</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax_A</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ax_A</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_A</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_A</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_A</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax_B</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_B</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">legend</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">col_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> 
                        <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> 
                        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">),</span> 
                        <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> 
                        <span class="n">handlelength</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                        <span class="n">handletextpad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                        <span class="n">markerscale</span><span class="o">=</span><span class="mi">2</span>
                        <span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  
    <span class="n">legend</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>    

    <span class="k">if</span> <span class="n">save_key</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="ret_sign">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.ret_sign">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ret_sign</span><span class="p">(</span>
    <span class="n">number</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return &#39;+&#39; if number ≥ 0, else &#39;-&#39;.</span>
<span class="sd">    Helper for `label_transfer_acc`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    number : float</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        &#39;+&#39; or &#39;-&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sign_str</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign_str</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
    <span class="k">return</span>  <span class="n">sign_str</span>  </div>


<div class="viewcode-block" id="is_bright">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.is_bright">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_bright</span><span class="p">(</span>
        <span class="n">hex_color</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether a hex RGB color is “bright” based on luminance,</span>
<span class="sd">    to choose black or white text for readability.</span>
<span class="sd">    Helper for `label_transfer_acc`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hex_color : str</span>
<span class="sd">        Hex code (e.g. &#39;#RRGGBB&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        &#39;black&#39; if background is light, &#39;white&#39; otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hex_color</span> <span class="o">=</span> <span class="n">hex_color</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex_color</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">luminance</span> <span class="o">=</span> <span class="mf">0.299</span> <span class="o">*</span> <span class="n">R</span> <span class="o">+</span> <span class="mf">0.587</span> <span class="o">*</span> <span class="n">G</span> <span class="o">+</span> <span class="mf">0.114</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">100</span> 
    <span class="k">if</span> <span class="n">luminance</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;white&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;black&#39;</span>   </div>


<div class="viewcode-block" id="label_transfer_acc">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.label_transfer_acc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">label_transfer_acc</span><span class="p">(</span>
        <span class="n">df_nns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">df_sim</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">save_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>         
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare balanced-accuracy of label-transfer by data-level NNs vs. scSpecies similarity-based label transfer</span>
<span class="sd">    and plot horizontal bar stacks of top-k context votes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_nns : pd.DataFrame</span>
<span class="sd">        Confusion-matrix-based accuracy of kNN transfers.</span>
<span class="sd">    df_sim : pd.DataFrame</span>
<span class="sd">        Confusion-matrix-based accuracy using scSpecies similarity.</span>
<span class="sd">    save_key : str or None, default=None</span>
<span class="sd">        If a string, the plot will be saved to `figures/{save_key}.png`. If None, it will only be displayed.   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">context_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_sim</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">target_cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_sim</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">context_cell_types</span><span class="p">,</span> <span class="n">target_cell_types</span><span class="p">)))</span>
    <span class="n">common_labels</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c_ind_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">context_cell_types</span><span class="p">,</span> <span class="n">target_cell_types</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mf">0.9</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">target_cell_types</span><span class="p">)</span><span class="o">*</span><span class="mi">11</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">20</span>

    <span class="n">palette</span> <span class="o">=</span> <span class="n">return_palette</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span>

    <span class="n">legend</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">cell</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">context_cell_types</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  
    <span class="n">legend</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span> 

    <span class="n">improvement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_nns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">common_labels</span><span class="p">])</span>

    <span class="n">cells_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df_nns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df_nns</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">cells_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df_sim</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">values_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df_nns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df_nns</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">values_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df_sim</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>

    <span class="n">str_old</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">all_labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cells_old</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">df_nns</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)))]</span>
    <span class="n">str_new</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">all_labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cells_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">df_sim</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)))]</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">target_cell_types</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_ind_b</span><span class="p">):</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret_sign</span><span class="p">(</span><span class="n">improvement</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">improvement</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">tick_colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">numb</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">numb</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#212121&#39;</span><span class="p">]</span> 
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">20</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#b71c1c&#39;</span><span class="p">]</span>     
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#c62828&#39;</span><span class="p">]</span> 
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#e53935&#39;</span><span class="p">]</span> 
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#e57373&#39;</span><span class="p">]</span> 
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#212121&#39;</span><span class="p">]</span> 
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#66bb6a&#39;</span><span class="p">]</span> 
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#4caf50&#39;</span><span class="p">]</span>         
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#43a047&#39;</span><span class="p">]</span>    
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">tick_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;#388e3c&#39;</span><span class="p">]</span>   
    <span class="n">tick_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tick_colors</span><span class="p">)</span>    

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_nns</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_cell_types</span><span class="p">)):</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">x_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_positions</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">values_new</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">palette</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells_new</span><span class="p">[:,</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">x_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p_2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x_positions</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">values_old</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values_old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">palette</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells_old</span><span class="p">[:,</span><span class="n">i</span><span class="p">]])</span>    

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_nns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">df_nns</span><span class="o">.</span><span class="n">index</span><span class="p">)]),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">*</span><span class="mf">0.95</span><span class="p">)</span><span class="c1">#</span>
    <span class="n">ax_t</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_yaxis</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;inout&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span><span class="c1">#</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">tick_colors</span><span class="p">)):</span>
        <span class="n">ax_t</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span><span class="c1">#</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">ax_f</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">ax_f</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax_f</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">)]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span><span class="c1">#</span>
    <span class="n">ax_f</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_positions</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">values_new</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mf">5.5</span><span class="p">,</span> <span class="n">x_pos</span><span class="o">-</span><span class="p">(</span><span class="mf">0.45</span><span class="o">-</span><span class="n">add</span><span class="p">),</span> <span class="n">str_new</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">is_bright</span><span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="n">cells_new</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]]))</span>       
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">values_old</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mf">5.5</span><span class="p">,</span> <span class="n">x_pos</span><span class="o">+</span><span class="p">(</span><span class="mf">0.05</span><span class="o">+</span><span class="n">add</span><span class="p">),</span> <span class="n">str_old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">is_bright</span><span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="n">cells_old</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]]))</span>        

    <span class="n">pos_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values_old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values_old</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> 
    <span class="n">pos_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> 

    <span class="k">def</span><span class="w"> </span><span class="nf">ret_val</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.15</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">0.25</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_positions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">values_new</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cells_new</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pos_new</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ret_val</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">x_pos</span><span class="o">-</span><span class="p">(</span><span class="mf">0.45</span><span class="o">-</span><span class="n">add</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">is_bright</span><span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="n">cells_new</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]]))</span>

            <span class="k">if</span> <span class="n">values_old</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cells_old</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>            
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pos_old</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ret_val</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">x_pos</span><span class="o">+</span><span class="p">(</span><span class="mf">0.05</span><span class="o">+</span><span class="n">add</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">is_bright</span><span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="n">cells_old</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]]))</span>        

    <span class="n">nn_old</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">df_nns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">common_labels</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nn_new</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">df_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">common_labels</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data-level neighbor search. Label transfer balanced accuracy: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nn_old</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%.</span><span class="se">\n</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;scSpecies similarity measure. Label transfer balanced accuracy: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nn_new</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%.</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">*</span><span class="mf">1.25</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_key</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_lfc_comparison">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.plot_lfc_comparison">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_lfc_comparison</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> 
        <span class="n">lfc_dict</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>         
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate and display a grid of scatter plots comparing log₂‐fold changes</span>
<span class="sd">    estimated by scSpecies against LFC computed directly from the data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : scSpecies</span>
<span class="sd">        A trained and evaluated scSpecies model instance.</span>
<span class="sd">    lfc_dict : dict of {str: pandas.DataFrame}</span>
<span class="sd">        List of LFC dataframes.</span>
<span class="sd">    save_key : str or None, default=None</span>
<span class="sd">        If a string, the plot will be saved to `figures/{save_key}.png`. If None, it will only be displayed.   </span>
<span class="sd">    &quot;&quot;&quot;</span>                        
                        

    <span class="n">target_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;homologous_genes&#39;</span><span class="p">])</span>
    <span class="n">target_gene_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;human&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">target_ind</span><span class="p">]</span>
    <span class="n">cell_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lfc_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">df_lfc_dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">target_gene_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cell_types</span><span class="p">)</span>

    <span class="n">spear</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pear</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">kend</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
        <span class="n">adata_target</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;human&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">target_config</span><span class="p">[</span><span class="s1">&#39;homologous_genes&#39;</span><span class="p">])]</span>
        <span class="n">adata_context</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mdata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">context_config</span><span class="p">[</span><span class="s1">&#39;homologous_genes&#39;</span><span class="p">])]</span>

        <span class="n">adata_target</span> <span class="o">=</span> <span class="n">adata_target</span><span class="p">[</span><span class="n">adata_target</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_type_fine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">adata_context</span> <span class="o">=</span> <span class="n">adata_context</span><span class="p">[</span><span class="n">adata_context</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_type_fine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata_context</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata_target</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">adata_context</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">adata_context</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">adata_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">adata_target</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">lfc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">adata_target</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">adata_context</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> 
        <span class="n">df_lfc_dat</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">lfc</span>

        <span class="n">sort_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lfc</span><span class="p">)</span>
        <span class="n">sort_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lfc_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">][</span><span class="s1">&#39;lfc&#39;</span><span class="p">])</span>

        <span class="n">spear</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">lfc</span><span class="p">,</span> <span class="n">lfc_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">][</span><span class="s1">&#39;lfc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span>
        <span class="n">pear</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">lfc</span><span class="p">,</span> <span class="n">lfc_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">][</span><span class="s1">&#39;lfc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span>
        <span class="n">kend</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">kendalltau</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lfc</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lfc</span><span class="p">[</span><span class="n">sort_model</span><span class="p">]))</span><span class="o">.</span><span class="n">statistic</span>   

    <span class="n">df_lfc</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">lfc_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">][</span><span class="s1">&#39;lfc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">})</span>

    <span class="n">n_cell_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>  
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_cell_types</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">n_cols</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_rows</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_types</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">df_lfc</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">df_lfc_dat</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_lfc</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;LFC data-level&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;LFC scSpecies&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ρ=</span><span class="si">{</span><span class="n">spear</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;PCC=</span><span class="si">{</span><span class="n">pear</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;τ=</span><span class="si">{</span><span class="n">kend</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
        <span class="s2">&quot;LFC: scSpecies vs data-level</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Avg ρ=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">spear</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Avg PCC=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pear</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Avg τ=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kend</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">save_key</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_key</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>    </div>


<div class="viewcode-block" id="return_palette">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.return_palette">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">return_palette</span><span class="p">(</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">col_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a color mapping for a list of labels, using predefined overrides</span>
<span class="sd">    and extending with Glasbey palette for unknowns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    names : sequence of str</span>
<span class="sd">        Labels to assign colors.</span>
<span class="sd">    col_dict : dict, optional</span>
<span class="sd">        Predefined name→hex mappings.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[str, str]</span>
<span class="sd">        Mapping from each unique name in `names` to a hex color code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">col_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">col_dict</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
        <span class="s1">&#39;human&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mouse&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hamster&#39;</span><span class="p">:</span>                  <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span>

        <span class="s1">&#39;Stromal Cells&#39;</span><span class="p">:</span>            <span class="s1">&#39;#ff4500&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Endothelial&#39;</span><span class="p">:</span>              <span class="s1">&#39;#ffbf00&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Mesothelial Cells&#39;</span><span class="p">:</span>        <span class="s1">&#39;#E0115F&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mono/Mono Derived&#39;</span><span class="p">:</span>        <span class="s1">&#39;#4f86f7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NK/NKT&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#839B17&#39;</span><span class="p">,</span> 

        <span class="s1">&#39;CD4+ KLRB1 Th&#39;</span><span class="p">:</span>            <span class="s1">&#39;#74C365&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Circ. NK&#39;</span><span class="p">:</span>                 <span class="s1">&#39;#8F9779&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Gamma-Delta T&#39;</span><span class="p">:</span>            <span class="s1">&#39;#9acd32&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Mesothelial Cells&#39;</span><span class="p">:</span>        <span class="s1">&#39;#E0115F&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mig. DCs&#39;</span><span class="p">:</span>                 <span class="s1">&#39;#8f00ff&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;NK Cells&#39;</span><span class="p">:</span>                 <span class="s1">&#39;#568203&#39;</span><span class="p">,</span>      
        <span class="s1">&#39;NKT Cells&#39;</span><span class="p">:</span>                <span class="s1">&#39;#043927&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Pat. Monocytes&#39;</span><span class="p">:</span>           <span class="s1">&#39;#008ECC&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Peritoneal Macs&#39;</span><span class="p">:</span>          <span class="s1">&#39;#6960EC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pre-moKCs and moKCs&#39;</span><span class="p">:</span>      <span class="s1">&#39;#38ACEC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;RM CD8+ T cells&#39;</span><span class="p">:</span>          <span class="s1">&#39;#D0F0C0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellate Cells&#39;</span><span class="p">:</span>           <span class="s1">&#39;#ff033e&#39;</span><span class="p">,</span>  
        <span class="s1">&#39;Th 1&#39;</span><span class="p">:</span>                     <span class="s1">&#39;#50C878&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Th 17&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#00A86B&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Tissue Resident NK&#39;</span><span class="p">:</span>       <span class="s1">&#39;#708238&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Trans. Monocytes 2&#39;</span><span class="p">:</span>       <span class="s1">&#39;#6495ED&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cDCs 1&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#6F2DA8&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;cDCs 2&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#81007F&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;immLAMs&#39;</span><span class="p">:</span>                  <span class="s1">&#39;#000080&#39;</span><span class="p">,</span>
        <span class="s1">&#39;matLAMs&#39;</span><span class="p">:</span>                  <span class="s1">&#39;#1035AC&#39;</span><span class="p">,</span>

        <span class="s1">&#39;B Cells&#39;</span><span class="p">:</span>                  <span class="s1">&#39;#964b00&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Basophils&#39;</span><span class="p">:</span>                <span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cDC1s&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#6F2DA8&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;cDC2s&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#81007F&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;pDCs&#39;</span><span class="p">:</span>                     <span class="s1">&#39;#D891EF&#39;</span><span class="p">,</span>        
        <span class="s1">&#39;Plasma&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#c19a6b&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NK&#39;</span><span class="p">:</span>                       <span class="s1">&#39;#568203&#39;</span><span class="p">,</span>         
        <span class="s1">&#39;NKT&#39;</span><span class="p">:</span>                      <span class="s1">&#39;#043927&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Gamma delta T Cells&#39;</span><span class="p">:</span>      <span class="s1">&#39;#9acd32&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Fibroblasts&#39;</span><span class="p">:</span>              <span class="s1">&#39;#ff3800&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Hepatocytes&#39;</span><span class="p">:</span>              <span class="s1">&#39;#ff0090&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellate&#39;</span><span class="p">:</span>                 <span class="s1">&#39;#ff033e&#39;</span><span class="p">,</span>  
        <span class="s1">&#39;Regulatory T&#39;</span><span class="p">:</span>             <span class="s1">&#39;#0B6623&#39;</span><span class="p">,</span>	
        <span class="s1">&#39;Monocytes&#39;</span><span class="p">:</span>                <span class="s1">&#39;#87CDEE&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Neutrophils&#39;</span><span class="p">:</span>              <span class="s1">&#39;#8c8784&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Circulating NK&#39;</span><span class="p">:</span>           <span class="s1">&#39;#8F9779&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cholangiocytes&#39;</span><span class="p">:</span>           <span class="s1">&#39;#c90016&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;LSECs&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#ffa700&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;KCs&#39;</span><span class="p">:</span>                      <span class="s1">&#39;#00bfff&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Migratory cDCs&#39;</span><span class="p">:</span>           <span class="s1">&#39;#8f00ff&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Imm. LAMs&#39;</span><span class="p">:</span>                <span class="s1">&#39;#000080&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mat. LAMs&#39;</span><span class="p">:</span>                <span class="s1">&#39;#1035AC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MoMac1&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#0020C2&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Cytotoxic CD8+&#39;</span><span class="p">:</span>           <span class="s1">&#39;#A7F432&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Patrolling Mono.&#39;</span><span class="p">:</span>         <span class="s1">&#39;#008ECC&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Tissue Res. NK&#39;</span><span class="p">:</span>           <span class="s1">&#39;#708238&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Circ. Eff. Memory T&#39;</span><span class="p">:</span>      <span class="s1">&#39;#98FB98&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Portal Vein ECs&#39;</span><span class="p">:</span>          <span class="s1">&#39;#ffd700&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pre-moKCs/moKCs&#39;</span><span class="p">:</span>          <span class="s1">&#39;#38ACEC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Central Vein ECs&#39;</span><span class="p">:</span>         <span class="s1">&#39;#fcc200&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Naive/CM CD4+ T&#39;</span><span class="p">:</span>          <span class="s1">&#39;#2E8B57&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;CD4+ KLRB1 T&#39;</span><span class="p">:</span>             <span class="s1">&#39;#74C365&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Tissue Res. CD8+ T&#39;</span><span class="p">:</span>       <span class="s1">&#39;#D0F0C0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Trans. Mono. 1&#39;</span><span class="p">:</span>           <span class="s1">&#39;#b5d7fd&#39;</span><span class="p">,</span>  
        <span class="s1">&#39;Trans. Mono. 2&#39;</span><span class="p">:</span>           <span class="s1">&#39;#82EEFD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Th17s&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#00A86B&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Th1s&#39;</span><span class="p">:</span>                     <span class="s1">&#39;#50C878&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mesothelial&#39;</span><span class="p">:</span>              <span class="s1">&#39;#E0115F&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Peritoneal Mac.&#39;</span><span class="p">:</span>          <span class="s1">&#39;#6960EC&#39;</span><span class="p">,</span>

        <span class="s1">&#39;B/Plasma&#39;</span><span class="p">:</span>                 <span class="s1">&#39;#6F4E37&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Naive CD8+ T&#39;</span><span class="p">:</span>             <span class="s1">&#39;#A8E4A0&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;RM CD8+ T Cells&#39;</span><span class="p">:</span>          <span class="s1">&#39;#D0F0C0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CD8 Eff. Memory T&#39;</span><span class="p">:</span>        <span class="s1">&#39;#D1FFBD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;T Cells&#39;</span><span class="p">:</span>                  <span class="s1">&#39;#4CBB17&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Naive CD4+ T&#39;</span><span class="p">:</span>             <span class="s1">&#39;#48A860&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CD4+ T helper&#39;</span><span class="p">:</span>            <span class="s1">&#39;#50a88b&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;NK/NKT Cells&#39;</span><span class="p">:</span>             <span class="s1">&#39;#839B17&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;ILCs&#39;</span><span class="p">:</span>                     <span class="s1">&#39;#7fff00&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Prol. TAM&#39;</span><span class="p">:</span>                <span class="s1">&#39;#93FFE8&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Bile-duct LAMs&#39;</span><span class="p">:</span>           <span class="s1">&#39;#5865F2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MoMac2&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#0041C2&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;CV/Capsule Cd207+ Macs&#39;</span><span class="p">:</span>   <span class="s1">&#39;#1D2951&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Macrophages&#39;</span><span class="p">:</span>              <span class="s1">&#39;#101D6B&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Monocytes 1&#39;</span><span class="p">:</span>              <span class="s1">&#39;#1974D2&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Monocytes 2&#39;</span><span class="p">:</span>              <span class="s1">&#39;#0909FF&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Mono/mono-derived&#39;</span><span class="p">:</span>        <span class="s1">&#39;#4f86f7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Trans. Monocytes&#39;</span><span class="p">:</span>         <span class="s1">&#39;#6495ED&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mast Cells&#39;</span><span class="p">:</span>               <span class="s1">&#39;#00CC99&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;DCs&#39;</span><span class="p">:</span>                      <span class="s1">&#39;#80008B&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;DCs 3&#39;</span><span class="p">:</span>                    <span class="s1">&#39;#342D7E&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cDCs&#39;</span><span class="p">:</span>                     <span class="s1">&#39;#80008B&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;pre-DC&#39;</span><span class="p">:</span>                   <span class="s1">&#39;#36013F&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Endothelials&#39;</span><span class="p">:</span>             <span class="s1">&#39;#ffbf00&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Lymphatic ECs&#39;</span><span class="p">:</span>            <span class="s1">&#39;#FCE205&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Lymphatic ECs 1&#39;</span><span class="p">:</span>          <span class="s1">&#39;#C35817&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Lymphatic ECs 2&#39;</span><span class="p">:</span>          <span class="s1">&#39;#C04000&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Endometrium&#39;</span><span class="p">:</span>              <span class="s1">&#39;#FF8C00&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Capsule Fibroblasts&#39;</span><span class="p">:</span>      <span class="s1">&#39;#cf1020&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Fibroblast 1&#39;</span><span class="p">:</span>             <span class="s1">&#39;#f08080&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Fibroblast 2&#39;</span><span class="p">:</span>             <span class="s1">&#39;#ff4500&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Stromal&#39;</span><span class="p">:</span>                  <span class="s1">&#39;#ff4500&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Adipocytes&#39;</span><span class="p">:</span>               <span class="s1">&#39;#FF2400&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Pericytes&#39;</span><span class="p">:</span>                <span class="s1">&#39;#FE5BAC&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Myo Epithelials&#39;</span><span class="p">:</span>          <span class="s1">&#39;#98AFC7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Platelets&#39;</span><span class="p">:</span>                <span class="s1">&#39;#837E7C&#39;</span><span class="p">,</span>
    <span class="p">}}</span>

    <span class="n">name_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="n">lenght</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_list</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">glasbey</span><span class="o">.</span><span class="n">extend_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">,</span> <span class="n">palette_size</span><span class="o">=</span><span class="n">lenght</span><span class="p">)</span>

    <span class="n">palette</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>       
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">col_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">palette</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Assingning color to unknown cell type: &#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="n">palette</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">)</span>
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            
    <span class="k">return</span> <span class="n">palette</span></div>



<div class="viewcode-block" id="load_and_filter_pathways">
<a class="viewcode-back" href="../../scspecies.html#scspecies.plot.load_and_filter_pathways">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_and_filter_pathways</span><span class="p">(</span>
        <span class="n">gmt_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> 
        <span class="n">min_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load pathway gene sets from a GMT file and filter to those</span>
<span class="sd">    with at least `min_genes` overlapping with adata.var_names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gmt_path : str</span>
<span class="sd">        Path to the .gmt file.</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        AnnData object with .var_names (genes).</span>
<span class="sd">    min_genes : int</span>
<span class="sd">        Minimum number of overlapping genes to keep a pathway.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filtered_pathways : dict</span>
<span class="sd">        Mapping of pathway names to lists of overlapping gene symbols.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pathways</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gmt_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gene_list</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">pathways</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_list</span>

    <span class="n">var_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">genes</span> <span class="ow">in</span> <span class="n">pathways</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">var_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_genes</span><span class="p">:</span>
            <span class="n">filtered</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Clemens Schächter.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>